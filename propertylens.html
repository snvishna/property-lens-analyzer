<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyLens: The Professional Real Estate Investment Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,%3Csvg width='512' height='512' viewBox='0 0 512 512' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cmarker id='arrow' viewBox='0 0 10 10' refX='8' refY='5' markerWidth='2.75' markerHeight='2.75' orient='auto-start-reverse'%3E%3Cpath d='M 0 0 L 10 5 L 0 10 z' fill='%23F39C12'/%3E%3C/marker%3E%3C/defs%3E%3Ccircle cx='256' cy='256' r='256' fill='%232C3E50'/%3E%3Cpath d='M392 232L256 112L120 232V400H392V232Z' fill='%23FFFBEB'/%3E%3Cpath d='M120 400L224 272L288 352L378 172' stroke='%23F39C12' stroke-width='22' stroke-linecap='round' stroke-linejoin='round' marker-end='url(%23arrow)'/%3E%3C/svg%3E">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "462934927f434e80833b3a19986150aa"}'></script>
    <style>
        :root {
            --strategy-cashflow: #1565C0;
            --strategy-valueadd: #2E7D32;
            --strategy-appreciation: #6A1B9A;
            --strategy-color: var(--strategy-cashflow); /* Default */
            --strategy-color-alpha: rgba(21, 101, 192, 0.1); /* Default */
        }

        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }

        @media (min-width: 1024px) {
            .custom-scrollbar::-webkit-scrollbar { width: 8px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        }
        
        .table-wrapper { overflow-x: auto; }

        .tooltip-container { display: inline-flex; align-items: center; }
        .help-icon { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 1rem; 
            height: 1rem; 
            border-radius: 9999px; 
            background-color: #e2e8f0; 
            color: #475569; 
            font-size: 0.7rem; 
            font-weight: bold; 
            cursor: pointer; 
            margin-left: 0.3rem; 
            transition: background-color 0.2s; 
            transform: translateY(-0.5px);
        }
        .help-icon:hover { background-color: #cbd5e1; }
        #global-tooltip { position: fixed; background-color: #0f172a; color: #f1f5f9; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; text-align: left; white-space: normal; z-index: 10000; width: max-content; max-width: 300px; pointer-events: none; opacity: 0; transform: scale(0.95); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; will-change: transform, opacity; border: 1px solid #334155; }
        #global-tooltip.visible { opacity: 1; transform: scale(1); }

        .input-group { position: relative; }
        .input-group input, .input-group select { background-color: #f8fafc; border-color: #cbd5e1; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; padding-top: 0.6rem; padding-bottom: 0.6rem; }
        .input-group input:focus, .input-group select:focus { border-color: var(--strategy-color); box-shadow: 0 0 0 3px var(--strategy-color-alpha); outline: none; background-color: #fff; }
        .input-group.invalid input, .input-group.invalid select { border-color: #ef4444; background-color: #fee2e2; }
        .input-group.invalid input:focus, .input-group.invalid select:focus { box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); }
        
        .validation-error { color: #b91c1c; font-size: 0.75rem; margin-top: 0.25rem; display: flex; align-items: center; gap: 0.25rem; opacity: 0; max-height: 0; transition: opacity 0.3s ease, max-height 0.3s ease; overflow: hidden; }
        .input-group.invalid .validation-error { opacity: 1; max-height: 2rem; }
        
        .break-even-row { background-color: #dcfce7 !important; font-weight: 600; }
        .break-even-row td:first-child::after { content: ' (Payback)'; font-size: 0.7rem; color: #15803d; vertical-align: middle; margin-left: 4px; }
        
        .strategy-option.strategy-selected > div { border-color: var(--strategy-color); box-shadow: 0 0 0 2px var(--strategy-color); }
        .strategy-option.strategy-selected .strategy-radio { border-color: var(--strategy-color); }
        .strategy-option.strategy-selected .strategy-radio > div { opacity: 1; }
        
        .toggle-switch { display: inline-flex; align-items: center; cursor: pointer; }
        .toggle-switch-track { width: 34px; height: 20px; background-color: #d1d5db; border-radius: 9999px; position: relative; transition: background-color 0.2s ease-in-out; }
        .toggle-switch-thumb { display: block; width: 16px; height: 16px; background-color: white; border-radius: 9999px; position: absolute; top: 2px; left: 2px; transition: transform 0.2s ease-in-out; }
        .toggle-switch input:checked + .toggle-switch-track { background-color: var(--strategy-color); }
        .toggle-switch input:checked + .toggle-switch-track > .toggle-switch-thumb { transform: translateX(14px); }

        details { border: 1px solid #e2e8f0; border-radius: 0.75rem; transition: background-color 0.2s; }
        details:not(:last-child) { margin-bottom: 1rem; }
        details summary { padding: 1rem; }
        .details-content { padding: 0 1rem 1rem 1rem; }
        details summary::-webkit-details-marker { display: none; }
        details summary .arrow { transition: transform 0.2s; }
        details[open] { background-color: #f8fafc; border-color: #cbd5e1; }
        details[open] summary .arrow { transform: rotate(90deg); }
        
        .metric-highlight { border-width: 1px; border-style: solid; border-radius: 0.5rem; transition: all 0.3s ease-in-out; }
        #scenarioModal.hidden { display: none; }
        #manageScenariosBtn { border-color: var(--strategy-color); color: var(--strategy-color); transition: background-color 0.2s; }
        #manageScenariosBtn:hover { background-color: var(--strategy-color-alpha); }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">

    <header class="flex-shrink-0 bg-slate-100/80 backdrop-blur-sm border-b z-10 border-slate-200">
        <div class="container mx-auto px-4 lg:px-8 py-4">
            <div class="flex flex-wrap sm:flex-nowrap justify-between items-center gap-4">
    
                <div class="flex items-center gap-3">
                    <img src="data:image/svg+xml,%3Csvg width='512' height='512' viewBox='0 0 512 512' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cmarker id='arrow' viewBox='0 0 10 10' refX='8' refY='5' markerWidth='2.75' markerHeight='2.75' orient='auto-start-reverse'%3E%3Cpath d='M 0 0 L 10 5 L 0 10 z' fill='%23F39C12'/%3E%3C/marker%3E%3C/defs%3E%3Ccircle cx='256' cy='256' r='256' fill='%232C3E50'/%3E%3Cpath d='M392 232L256 112L120 232V400H392V232Z' fill='%23FFFBEB'/%3E%3Cpath d='M120 400L224 272L288 352L378 172' stroke='%23F39C12' stroke-width='22' stroke-linecap='round' stroke-linejoin='round' marker-end='url(%23arrow)'/%3E%3C/svg%3E" alt="PropertyLens Logo" class="w-10 h-10" />
                    <div>
                        <h1 id="appHeader" class="text-2xl font-bold text-slate-900 transition-colors duration-300 leading-tight">PropertyLens</h1>
                        <p class="text-slate-500 text-sm leading-tight">The Professional Real Estate Investment Analyzer</p>
                    </div>
                </div>
    
                <div class="flex-shrink-0 flex items-center gap-2">
                    <a href="https://github.com/snvishna/property-lens-analyzer" target="_blank" rel="noopener noreferrer" class="p-2 rounded-full text-slate-500 hover:text-slate-900 hover:bg-slate-200 transition-colors" title="View on GitHub">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                    </a>
                    <button id="manageScenariosBtn" class="font-semibold py-2 px-4 border rounded-lg shadow-sm text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>
                        <span>Scenarios</span>
                    </button>
                </div>
                
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto flex flex-col lg:relative px-4 lg:px-8 min-h-0">
        <section class="lg:absolute lg:inset-y-0 lg:left-0 lg:w-5/12 lg:overflow-y-auto custom-scrollbar py-8 lg:pr-4">
            <div class="space-y-0">
                <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                     <details open>
                        <summary class="flex items-center justify-between text-xl font-semibold text-slate-800 cursor-pointer list-none">
                            Investment Strategy
                            <div class="arrow w-5 h-5 mr-3 text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </summary>
                        <div class="details-content mt-4 space-y-3">
                             <label class="strategy-option group cursor-pointer" style="--strategy-color: var(--strategy-cashflow);">
                                <input type="radio" name="investmentStrategy" value="cashflow" class="sr-only">
                                <div class="flex items-center p-4 border rounded-lg transition-all group-hover:border-current group-hover:bg-blue-50 border-slate-200">
                                    <div class="flex items-center flex-1">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xl mr-4" style="background-color: var(--strategy-color);">💰</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-slate-900">Cash Flow</h3>
                                            <p class="text-sm text-slate-600 mt-1">Maximize immediate monthly income.</p>
                                        </div>
                                    </div>
                                    <div class="strategy-radio w-5 h-5 border-2 border-slate-300 rounded-full flex items-center justify-center">
                                        <div class="w-2.5 h-2.5 rounded-full opacity-0 transition-opacity" style="background-color: var(--strategy-color);"></div>
                                    </div>
                                </div>
                            </label>
                             <label class="strategy-option group cursor-pointer" style="--strategy-color: var(--strategy-valueadd);">
                                <input type="radio" name="investmentStrategy" value="valueadd" class="sr-only">
                                 <div class="flex items-center p-4 border border-slate-200 rounded-lg transition-all group-hover:border-current group-hover:bg-green-50">
                                    <div class="flex items-center flex-1">
                                         <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xl mr-4" style="background-color: var(--strategy-color);">🏦</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-slate-900">Value-Add (BRRRR)</h3>
                                            <p class="text-sm text-slate-600 mt-1">Force appreciation through renovations.</p>
                                        </div>
                                    </div>
                                    <div class="strategy-radio w-5 h-5 border-2 border-slate-300 rounded-full flex items-center justify-center">
                                        <div class="w-2.5 h-2.5 rounded-full opacity-0 transition-opacity" style="background-color: var(--strategy-color);"></div>
                                    </div>
                                </div>
                            </label>
                             <label class="strategy-option group cursor-pointer" style="--strategy-color: var(--strategy-appreciation);">
                                <input type="radio" name="investmentStrategy" value="appreciation" class="sr-only">
                                 <div class="flex items-center p-4 border border-slate-200 rounded-lg transition-all group-hover:border-current group-hover:bg-purple-50">
                                    <div class="flex items-center flex-1">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xl mr-4" style="background-color: var(--strategy-color);">📈</div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-slate-900">Appreciation</h3>
                                            <p class="text-sm text-slate-600 mt-1">Long-term wealth growth in high-demand markets.</p>
                                        </div>
                                    </div>
                                    <div class="strategy-radio w-5 h-5 border-2 border-slate-300 rounded-full flex items-center justify-center">
                                        <div class="w-2.5 h-2.5 rounded-full opacity-0 transition-opacity" style="background-color: var(--strategy-color);"></div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </details>
                    
                     <details open>
                        <summary class="flex items-center justify-between text-xl font-semibold text-slate-800 cursor-pointer list-none">
                            Purchase & Loan
                            <div class="arrow w-5 h-5 mr-3 text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </summary>
                         <div class="details-content mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-5">
                            <div class="input-group md:col-span-2">
                                <label for="purchasePrice" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The total price you are paying for the property. This is the starting point for most calculations and forms the basis for your loan, down payment, and depreciation.">Purchase Price <span class="help-icon">?</span></span></label>
                                <input type="text" id="purchasePrice" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="rehabCosts" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The total cost of initial repairs and renovations to get the property rent-ready. This is part of your initial investment (Total Cash Needed) and is crucial for value-add or BRRRR strategies.">Rehab Costs ($) <span class="help-icon">?</span></span></label>
                                <input type="text" id="rehabCosts" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="closingCosts" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="One-time fees paid to close the deal (e.g., title, legal, appraisal). This adds to your initial cash outlay.<br><br><strong>Benchmark:</strong> Typically 2-5% of the Purchase Price.">Closing Costs ($) <span class="help-icon">?</span></span></label>
                                <input type="text" id="closingCosts" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group md:col-span-2">
                                <label for="arv" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The estimated market value of the property *after* all planned repairs and improvements are completed. This is essential for calculating 'Forced Equity' and is the cornerstone of a BRRRR or value-add strategy.">After Repair Value (ARV) <span class="help-icon">?</span></span></label>
                                <input type="text" id="arv" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="loanType" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Select the type of loan you are modeling. This choice significantly impacts your monthly payment, interest costs, and overall returns.">Loan Type <span class="help-icon">?</span></span></label>
                                <select id="loanType" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <optgroup label="Conventional Fixed">
                                        <option value="fixed30">30-Year Fixed</option>
                                        <option value="fixed15">15-Year Fixed</option>
                                    </optgroup>
                                    <optgroup label="Adjustable Rate (ARM)">
                                        <option value="arm10">10/6 ARM</option>
                                        <option value="arm7">7/1 ARM</option>
                                    </optgroup>
                                     <optgroup label="Alternative Financing">
                                        <option value="margin">Margin Loan</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div id="downPaymentGroup" class="input-group">
                                <label for="downPayment" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The percentage of the Purchase Price you pay out-of-pocket. A larger down payment reduces your loan amount and risk, but also reduces leverage and may lower your CoC ROI.<br><br><strong>Benchmark:</strong> Typically 20-25% for investment properties.">Down Payment (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="downPayment" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <p id="downPaymentHelper" class="text-xs text-slate-500 mt-1">Value: $0</p>
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div id="fixedRateGroup" class="input-group md:col-span-2">
                                 <label for="interestRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The annual interest rate for your loan. This is a major driver of your monthly payment and overall profitability.">Interest Rate (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="interestRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div id="armRateGroup" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div class="input-group">
                                    <label for="initialInterestRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The interest rate for the initial fixed period of the ARM (e.g., the first 7 years of a 7/1 ARM).">Initial Rate (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="initialInterestRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="adjustedInterestRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Your conservative estimate for the interest rate after the fixed period ends. This is crucial for stress-testing an ARM's long-term viability.">Est. Adjusted Rate (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="adjustedInterestRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                             <div id="marginLoanGroup" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div class="input-group">
                                    <label for="marginInterestRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The annual interest rate for your margin loan. Note that these are typically variable rates.">Interest Rate (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="marginInterestRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="marginRepaymentPct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The percentage of monthly profit (after meeting your Min. Cash Flow target) that will be used to pay down the margin loan. 100% is the most aggressive paydown strategy.">Repayment from Excess Profit (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="marginRepaymentPct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                     <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="loanTerm">
                        </div>
                    </details>

                     <details>
                        <summary class="flex items-center justify-between text-xl font-semibold text-slate-800 cursor-pointer list-none">
                            Income & Expenses
                            <div class="arrow w-5 h-5 mr-3 text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </summary>
                         <div class="details-content mt-4 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-5">
                                <div class="input-group">
                                    <label for="grossMonthlyRent" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The total rent collected from all units each month, before any expenses. This is the primary driver of your property's income.">Gross Monthly Rent <span class="help-icon">?</span></span></label>
                                    <input type="text" id="grossMonthlyRent" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="otherIncome" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Any additional income from the property, such as coin laundry, parking fees, pet fees, or storage unit rentals.">Other Monthly Income <span class="help-icon">?</span></span></label>
                                    <input type="text" id="otherIncome" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-5">
                                <div class="input-group">
                                    <label for="propTaxes" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The monthly amount paid in property taxes. You can find this on a tax bill or real estate listing. Underestimating taxes is a common and costly mistake.">Property Taxes ($/mo) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="propTaxes" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="insurance" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The monthly cost of landlord's or hazard insurance for the property. Get a quote from an insurance agent for an accurate number.">Insurance ($/mo) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="insurance" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                 <div class="input-group">
                                    <label for="hoa" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Monthly fees paid to a Homeowners' Association, if applicable. These can sometimes cover utilities or exterior maintenance.">HOA ($/mo) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="hoa" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="otherExpenses" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Any other recurring monthly costs not listed above. Examples include utilities (if paid by landlord), landscaping, pest control, or snow removal.">Other Expenses ($/mo) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="otherExpenses" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-5">
                                <div class="input-group">
                                    <label for="vacancyPct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="A crucial budget for when the property is vacant between tenants. This protects your cash flow and is a key part of conservative underwriting.<br><br><strong>Benchmark:</strong> 5-10% of Gross Rent is a common estimate, depending on the market.">Vacancy (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="vacancyPct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="maintenancePct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="A budget for ongoing repairs and maintenance (e.g., leaky faucets, small fixes, appliance repairs). This is different from CapEx.<br><br><strong>Benchmark:</strong> 5-10% of Gross Rent is a safe starting point. Older properties may require a higher percentage.">Repairs (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="maintenancePct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="managementPct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The cost of hiring a property manager to handle tenants, rent collection, and maintenance. If you self-manage, it's wise to still include this cost to pay yourself for your time.<br><br><strong>Benchmark:</strong> 8-12% of collected rent is typical.">Mgmt. (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="managementPct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 mt-4 border-t border-slate-200">
                                <div id="capExPercentContainer" class="input-group">
                                    <label for="capExPct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="A savings fund for large, infrequent expenses like a new roof, HVAC, or water heater. Failing to budget for CapEx is one of the biggest reasons investors fail.<br><br><strong>Benchmark:</strong> 5-10% of Gross Rent is a wise budget. Use the toggle below to itemize specific large expenses for a more accurate forecast.">Capital Expenditures (CapEx) (%) <span class="help-icon">?</span></span></label>
                                    <input type="text" id="capExPct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <div class="validation-error">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                        <span></span>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between mt-3">
                                    <label for="useItemizedCapEx" class="text-sm font-medium text-slate-700">
                                        <span class="tooltip-container" data-tooltip="Use this for planning large, infrequent capital expenditures (CapEx).<br><br><strong>Examples:</strong> New Roof, HVAC Replacement, Major Renovations.<br><br>The 'Year' field is the <strong>relative year of ownership</strong> (e.g., enter '5' for an expense you expect in your fifth year).">
                                            Itemize Large Expenses Instead?
                                            <span class="help-icon">?</span>
                                        </span>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="useItemizedCapEx" class="sr-only">
                                        <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                    </label>
                                </div>

                                <div id="itemizedCapExContainer" class="hidden pt-4 mt-4 border-t border-slate-200">
                                    <p class="text-xs text-slate-600 mb-3">Model a value-add plan by forecasting specific large costs that will occur in certain years. These will be subtracted from cash flow in the specified year.</p>
                                    <div id="itemizedCapExList" class="space-y-3">
                                        </div>
                                    <button id="addCapExItemBtn" type="button" class="mt-4 text-sm font-semibold text-white rounded-md shadow-sm w-full py-2" style="background-color: var(--strategy-color);">+ Add Expense</button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <details>
                        <summary class="flex items-center justify-between text-xl font-semibold text-slate-800 cursor-pointer list-none">
                            Tax & Depreciation
                             <div class="arrow w-5 h-5 mr-3 text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </summary>
                        <div class="details-content mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-5">
                            <div class="input-group">
                                <label for="marginalTaxRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Your combined federal and state marginal income tax rate. This is the rate you pay on your *next dollar* of income and is used to calculate the tax impact of the property's income/loss and the value of deductions.">Marginal Tax Rate (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="marginalTaxRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="capitalGainsTaxRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Your long-term capital gains tax rate (federal + state). This is used to calculate the tax due on the property's appreciation when sold.">Capital Gains Rate (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="capitalGainsTaxRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="landValuePct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The percentage of the Purchase Price attributed to the land itself. Land does not depreciate.<br><br><strong>Benchmark:</strong> A common rule of thumb is 20%, but this can vary dramatically based on location. Check your property tax assessment for a more accurate value.">Land Value (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="landValuePct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group md:col-span-2">
                                <label for="depreciationMethod" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Depreciation is a non-cash tax deduction representing the 'wear and tear' on a property. It's a major financial benefit for investors because it reduces your taxable income without affecting your actual cash flow, creating a 'tax shield'. The 27.5-year schedule is the standard IRS requirement for residential rental property in the US.">Depreciation Method<span class="help-icon">?</span></span></label>
                                <select id="depreciationMethod" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                    <option value="residential">27.5-Year Residential</option>
                                    <option value="commercial" disabled>39-Year Commercial (Not Implemented)</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 p-3 bg-slate-100 rounded-md text-xs text-slate-600 flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                                <div>
                                    <span class="font-semibold">Depreciation Note:</span> A standard 27.5-year straight-line depreciation schedule is used. The depreciable basis is the Purchase Price minus the Land Value.
                                </div>
                            </div>
                        </div>
                    </details>
                    
                     <details>
                        <summary class="flex items-center justify-between text-xl font-semibold text-slate-800 cursor-pointer list-none">
                            Projections & Criteria
                            <div class="arrow w-5 h-5 mr-3 text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                            </div>
                        </summary>
                         <div class="details-content mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-5">
                             <div class="input-group">
                                <label for="annualIncomeGrowth" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The estimated annual percentage increase in rent and other income. This models your ability to raise rents over time.<br><br><strong>Benchmark:</strong> 2-3% is a common long-term estimate, often tied to inflation.">Income Growth (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="annualIncomeGrowth" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="annualExpenseGrowth" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The estimated annual percentage increase in operating expenses like taxes, insurance, and utilities.<br><br><strong>Benchmark:</strong> 2-3% is a common estimate. This should generally track your income growth assumption.">Expense Growth (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="annualExpenseGrowth" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="annualValueGrowth" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The estimated annual appreciation rate of the property's market value. This is a major driver of long-term wealth but does not affect monthly cash flow.<br><br><strong>Benchmark:</strong> Historically, 3-4% is a conservative long-term average for the US market.">Value Growth (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="annualValueGrowth" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="salesExpensesPct" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The estimated costs to sell the property in the future, as a percentage of the future sales price. This includes agent commissions, closing costs, and transfer taxes.<br><br><strong>Benchmark:</strong> 6-10% is a standard range.">Selling Costs (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="salesExpensesPct" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group md:col-span-2">
                                <label for="holdPeriod" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The number of years you plan to own the property. The analysis will show detailed projections for this duration.">Hold Period (Years) <span class="help-icon">?</span></span></label>
                                <input type="text" id="holdPeriod" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group md:col-span-2">
                                <label for="inflationRate" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The estimated annual inflation rate. This is used to calculate the 'real' (inflation-adjusted) return on your investment, showing the true growth in your purchasing power.<br><br><strong>Benchmark:</strong> A common long-term target is 2-3%.">Assumed Inflation Rate (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="inflationRate" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group md:col-span-2">
                                <label for="sp500Return" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Your personal forecast for the S&P 500's average annual return over your hold period. This is used in the 'Investment Showdown' comparison.<br><br><strong>Benchmark:</strong> The historical long-term average is around 8-10%.">S&P 500 Exp. Return (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="sp500Return" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                 <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="minCashFlow" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Your personal minimum acceptable monthly pre-tax cash flow. This is a key 'go/no-go' hurdle for a deal's viability. You can use a negative number if you are willing to subsidize the property for an appreciation play.">Min. Cash Flow ($/mo) <span class="help-icon">?</span></span></label>
                                <input type="text" id="minCashFlow" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="minCocRoi" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="Your minimum acceptable pre-tax Cash on Cash Return on Investment for Year 1. This measures the return on your initial cash investment.">Min. CoC ROI (%) <span class="help-icon">?</span></span></label>
                                <input type="text" id="minCocRoi" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="minForcedEquity" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The minimum amount of equity you want to create through the purchase and rehab (i.e., buying the property for less than its after-repair value). This is a primary metric for a Value-Add or BRRRR strategy.">Min. Forced Equity ($) <span class="help-icon">?</span></span></label>
                                <input type="text" id="minForcedEquity" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="lenderDscrReq" class="block text-sm font-medium text-slate-700"><span class="tooltip-container" data-tooltip="The minimum Debt Service Coverage Ratio required by the lender to approve the loan. This measures if the property's income can cover its debt payments.<br><br><strong>Benchmark:</strong> Lenders typically require a DSCR of 1.25 or higher.">Lender DSCR Req. <span class="help-icon">?</span></span></label>
                                <input type="text" id="lenderDscrReq" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm">
                                <div class="validation-error">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    <span></span>
                                </div>
                            </div>
                         </div>
                    </details>
                </div>
            </div>
        </section>

        <section class="lg:absolute lg:inset-y-0 lg:right-0 lg:w-7/12 lg:overflow-y-auto custom-scrollbar py-8 lg:pl-4">
            <div id="output-container" class="space-y-6"></div>
        </section>
        
    </main>

    <footer class="flex-shrink-0 bg-slate-200 border-t border-slate-300">
        <div class="container mx-auto px-4 lg:px-8 py-3 text-slate-500 text-xs">
            <div class="flex justify-between items-center">
                <p>&copy; <span id="copyright-year"></span> Nivas Homes GA, LLC. All Rights Reserved.</p>
                <p>This tool is for informational purposes only. Consult a professional for financial advice.</p>
            </div>
        </div>
    </footer>
        
    <div id="scenarioModal" class="hidden fixed inset-0 bg-slate-800/75 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white border-slate-300">
            <div class="flex justify-between items-center border-b pb-3 border-slate-200">
                <h3 class="text-2xl font-bold text-slate-900">Scenarios & Exports</h3>
                <button id="closeScenarioModal" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-6 mt-4">
                <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                    <h4 class="font-semibold text-slate-800">Save Current Analysis</h4>
                    <p class="text-xs text-slate-500 flex items-center gap-1 mb-3 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                        <span>Scenarios are saved to your browser's local storage, not a server.</span>
                    </p>
                    <div id="saveScenarioForm" class="hidden space-y-2">
                        <input type="text" id="scenarioNameInput" placeholder="Enter a name for this scenario..." class="block w-full rounded-md shadow-sm sm:text-sm bg-white border-slate-300">
                        <div class="flex items-center gap-2">
                            <button id="confirmSaveScenarioBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">Save</button>
                            <button id="cancelSaveScenarioBtn" class="flex-1 bg-white hover:bg-slate-100 text-slate-700 font-semibold py-2 px-4 border border-slate-300 rounded-lg text-sm transition-colors">Cancel</button>
                        </div>
                    </div>
                    <button id="showSaveFormBtn" class="w-full bg-slate-700 hover:bg-slate-800 text-white font-semibold py-2 px-4 border border-slate-700 rounded-lg shadow-sm text-sm transition-all duration-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                        <span>Save as New Scenario</span>
                    </button>
                </div>
                <div>
                    <h4 class="font-semibold text-slate-800 mb-3">Load Saved Scenarios</h4>
                    <div id="scenarioList" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center border-t pt-4 gap-4 border-slate-200">
                <div class="text-sm text-slate-600 text-center sm:text-left">
                    <span class="tooltip-container" data-tooltip="This feature allows you to save a complete backup of all your scenarios to a single CSV file. You can use this file to transfer your scenarios to another computer or to restore them if your browser data is cleared.">
                        <span class="font-semibold">Backup</span>
                        <span class="help-icon">?</span>:
                        <button id="importScenariosBtn" class="text-blue-600 hover:underline font-medium">Import Scenarios (CSV)</button> |
                        <button id="exportScenariosCsvBtn" class="text-blue-600 hover:underline font-medium">Export All Scenarios (CSV)</button>
                    </span>
                </div>
                <div class="flex-shrink-0 w-full sm:w-auto">
                    <button id="exportSelectedXlsxBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-5 rounded-lg text-sm transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed">
                        Export Selected (XLSX)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="global-tooltip"></div>

    <script>
        /**
         * @file PropertyLens: The Real Estate Investment Analyzer.
         * @author Shankar Raju for Nivas Homes GA, LLC
         * @version 24.2.0
         * @description Includes Itemized CapEx bugfix, new amortization chart, UI reorganization, and comprehensive tooltip enhancements.
         */
        const App = {
            config: {
                dom: {
                    inputs: {
                        investmentStrategy: 'investmentStrategy',
                        purchasePrice: 'purchasePrice', arv: 'arv', closingCosts: 'closingCosts', rehabCosts: 'rehabCosts',
                        downPayment: 'downPayment', loanType: 'loanType', interestRate: 'interestRate', initialInterestRate: 'initialInterestRate', adjustedInterestRate: 'adjustedInterestRate',
                        marginInterestRate: 'marginInterestRate', marginRepaymentPct: 'marginRepaymentPct',
                        loanTerm: 'loanTerm', grossMonthlyRent: 'grossMonthlyRent',
                        otherIncome: 'otherIncome', propTaxes: 'propTaxes', insurance: 'insurance', vacancyPct: 'vacancyPct',
                        maintenancePct: 'maintenancePct', managementPct: 'managementPct', capExPct: 'capExPct', hoa: 'hoa',
                        otherExpenses: 'otherExpenses', annualIncomeGrowth: 'annualIncomeGrowth', annualExpenseGrowth: 'annualExpenseGrowth',
                        annualValueGrowth: 'annualValueGrowth', salesExpensesPct: 'salesExpensesPct', holdPeriod: 'holdPeriod', sp500Return: 'sp500Return', landValuePct: 'landValuePct',
                        inflationRate: 'inflationRate',
                        marginalTaxRate: 'marginalTaxRate', capitalGainsTaxRate: 'capitalGainsTaxRate', depreciationMethod: 'depreciationMethod',
                        minCashFlow: 'minCashFlow', minCocRoi: 'minCocRoi', minForcedEquity: 'minForcedEquity', lenderDscrReq: 'lenderDscrReq', useItemizedCapEx: 'useItemizedCapEx', itemizedCapEx: 'itemizedCapExList',
                    },
                    outputs: {
                        outputContainer: 'output-container',
                        appHeader: 'appHeader', showdownCard: 'showdownCard', verdictText: 'verdictText', verdictChecklist: 'verdictChecklist',
                        // Dynamic Headline Metrics
                        headlineCashFlow: 'headlineCashFlow', 
                        headlineRoi: 'headlineRoi',
                        cashFlowTypeLabel: 'cashFlowTypeLabel',
                        cashFlowPeriodLabel: 'cashFlowPeriodLabel',
                        roiTypeLabel: 'roiTypeLabel',
                        roiPeriodLabel: 'roiPeriodLabel',
                        // Fixed Metrics
                        cashReserves: 'cashReserves', noi: 'noi', capRate: 'capRate', dscr: 'dscr', totalCashNeeded: 'totalCashNeeded',
                        forcedEquity: 'forcedEquity', debtYield: 'debtYield', ltvLtc: 'ltvLtc', 
                        averageRoe: 'averageRoe', 
                        // Quick Ratios
                        fiftyPercentRule: 'fiftyPercentRule', grm: 'grm', onePercentRule: 'onePercentRule',
                        projectionsTable: 'projectionsTable', expenseLegend: 'expenseLegend', profitBreakdownSummary: 'profitBreakdownSummary',
                        analysisOverTimeContainer: 'analysisOverTimeContainer',
                        analysisChartContainer: 'analysisChartContainer',
                        projectionsChart: 'projectionsChart',
                        projectionsChartToggle: 'projectionsChartToggle',
                        projectionsDataSelector: 'projectionsDataSelector',
                    },
                    groups: {
                        fixedRateGroup: 'fixedRateGroup', armRateGroup: 'armRateGroup', marginLoanGroup: 'marginLoanGroup',
                    },
                    helpers: { downPaymentHelper: 'downPaymentHelper' },
                    charts: { 
                        expenseChart: 'expenseChart',
                        profitWaterfallChart: 'returnWaterfallChart',
                        wealthProjectionChart: 'wealthProjectionChart',
                        optimalExitChart: 'optimalExitChart',
                        amortizationChart: 'amortizationChart',
                    },
                    toggles: {
                        wealthChartToggle: 'wealthChartToggle',
                        exitChartToggle: 'exitChartToggle',
                        breakdownToggle: 'breakdownToggle',
                        timeHorizonToggle: 'timeHorizonToggle',
                        taxStatusToggle: 'taxStatusToggle',
                        projectionsChartToggle: 'projectionsChartToggle',
                    }
                },
                defaults: {
                    investmentStrategy: 'cashflow', loanType: 'fixed30',
                    purchasePrice: 500000, arv: 550000, closingCosts: 12500, rehabCosts: 20000, downPayment: 25,
                    interestRate: 7.0, initialInterestRate: 4.5, adjustedInterestRate: 6.5, marginInterestRate: 5.35, marginRepaymentPct: 100,
                    loanTerm: 30, grossMonthlyRent: 3500, otherIncome: 0, propTaxes: 450,
                    insurance: 120, vacancyPct: 5, maintenancePct: 5, managementPct: 8, capExPct: 5, hoa: 0,
                    otherExpenses: 50, annualIncomeGrowth: 3, annualExpenseGrowth: 3, annualValueGrowth: 4,
                    salesExpensesPct: 7, holdPeriod: 10, inflationRate: 2.5, useItemizedCapEx: false, itemizedCapEx: [],
                    marginalTaxRate: 24, capitalGainsTaxRate: 15, depreciationMethod: 'residential', sp500Return: 8, landValuePct: 20,
                    minCashFlow: 200, minCocRoi: 8, minForcedEquity: 0, lenderDscrReq: 1.25,
                },
                strategyPresets: {
                    cashflow: { minCashFlow: 200, minCocRoi: 8, minForcedEquity: 0 },
                    valueadd: { minCashFlow: 0, minCocRoi: 0, minForcedEquity: 20000 },
                    appreciation: { minCashFlow: -100, minCocRoi: 0, minForcedEquity: 0 },
                },
                // NEW: Define strategyHighlights object
                strategyHighlights: {
                    cashflow: ['totalCashNeeded', 'noi', 'capRate', 'averageRoe'],
                    valueadd: ['totalCashNeeded', 'forcedEquity', 'dscr', 'debtYield'],
                    appreciation: ['noi', 'capRate', 'averageRoe', 'grm'], 
                },
                colors: {
                    strategy: { cashflow: '#1565C0', valueadd: '#2E7D32', appreciation: '#6A1B9A' },
                    status: { positive: '#2E7D32', negative: '#D32F2F', neutral: '#616161', dark: '#424242', warning: '#F57C00' },
                    chart: {
                        primary: ['#1565C0', '#D32F2F', '#F57C00', '#2E7D32', '#6A1B9A', '#00695C', '#5D4037', '#455A64'],
                        loanBalance: '#E0E0E0' 
                    }
                },
                strategyThemes: {
                    cashflow: { cssVar: 'var(--strategy-cashflow)', alpha: 'rgba(21, 101, 192, 0.1)' },
                    valueadd: { cssVar: 'var(--strategy-valueadd)', alpha: 'rgba(46, 125, 50, 0.1)' },
                    appreciation: { cssVar: 'var(--strategy-appreciation)', alpha: 'rgba(106, 27, 154, 0.1)' }
                },
                validationRules: {
                    purchasePrice: { required: true, isPositive: true, message: 'Must be a positive number.' },
                    arv: { required: true, isPositive: true, message: 'Must be a positive number.' },
                    closingCosts: { isNonNegative: true, message: 'Cannot be negative.' },
                    rehabCosts: { isNonNegative: true, message: 'Cannot be negative.' },
                    downPayment: { required: true, min: 0, max: 100, message: 'Must be between 0-100.' },
                    interestRate: { required: true, min: 0, max: 100, message: 'Must be between 0-100.' },
                    initialInterestRate: { required: true, min: 0, max: 100, message: 'Must be between 0-100.' },
                    adjustedInterestRate: { required: true, min: 0, max: 100, message: 'Must be between 0-100.' },
                    marginInterestRate: { required: true, min: 0, max: 100, message: 'Must be between 0-100.' },
                    marginRepaymentPct: { required: true, min: 0, max: 100, message: 'Must be between 0-100.' },
                    loanTerm: { required: true, isPositive: true, max: 50, message: 'Must be between 1-50.' },
                    grossMonthlyRent: { required: true, isPositive: true, message: 'Must be a positive number.' },
                    otherIncome: { isNonNegative: true, message: 'Cannot be negative.' },
                    propTaxes: { isNonNegative: true, message: 'Cannot be negative.' },
                    insurance: { isNonNegative: true, message: 'Cannot be negative.' },
                    hoa: { isNonNegative: true, message: 'Cannot be negative.' },
                    otherExpenses: { isNonNegative: true, message: 'Cannot be negative.' },
                    vacancyPct: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    maintenancePct: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    managementPct: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    capExPct: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    annualIncomeGrowth: { min: -100, max: 100, message: 'Must be a reasonable percentage.' },
                    landValuePct: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    annualExpenseGrowth: { min: -100, max: 100, message: 'Must be a reasonable percentage.' },
                    annualValueGrowth: { min: -100, max: 100, message: 'Must be a reasonable percentage.' },
                    salesExpensesPct: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    holdPeriod: { required: true, isPositive: true, max: 50, message: 'Must be between 1-50.' },
                    inflationRate: { min: -10, max: 20, message: 'Must be a reasonable percentage.' },
                    marginalTaxRate: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    capitalGainsTaxRate: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    minCashFlow: { message: 'Can be negative for appreciation plays.' },
                    minCocRoi: { min: 0, max: 100, message: 'Must be between 0-100.' },
                    minForcedEquity: { isNonNegative: true, message: 'Cannot be negative.' },
                    sp500Return: { min: -100, max: 100, message: 'Must be a reasonable percentage.' },
                    lenderDscrReq: { isPositive: true, message: 'Must be positive.' },
                },
                URL_KEY_MAP: {
                    investmentStrategy: 'is', purchasePrice: 'pp', arv: 'arv', closingCosts: 'cc', rehabCosts: 'rc',
                    downPayment: 'dp', loanType: 'lt', interestRate: 'ir', initialInterestRate: 'iir', adjustedInterestRate: 'air',
                    marginInterestRate: 'mir', marginRepaymentPct: 'mrp',
                    grossMonthlyRent: 'gmr', otherIncome: 'oi', propTaxes: 'pt', insurance: 'ins', vacancyPct: 'vac',
                    maintenancePct: 'main', managementPct: 'mgmt', capExPct: 'capx', hoa: 'hoa', otherExpenses: 'oe',
                    annualIncomeGrowth: 'ig', annualExpenseGrowth: 'eg', annualValueGrowth: 'vg', salesExpensesPct: 'sc',
                    holdPeriod: 'hp', inflationRate: 'inf', marginalTaxRate: 'mtr', capitalGainsTaxRate: 'cgtr', depreciationMethod: 'dm', landValuePct: 'lvp', sp500Return: 'spr',
                    minCashFlow: 'mcf', minCocRoi: 'mcr', minForcedEquity: 'mfe', lenderDscrReq: 'ldr', itemizedCapEx: 'ice', useItemizedCapEx: 'uice'
                },
            },

            state: {},
            charts: { 
                expense: null,
                profitWaterfall: null,
                wealthProjection: null,
                optimalExit: null,
                amortization: null,
            },
            _debounceTimer: null,
            _lastStateJSON: '',
            lastResults: null, // Cache for chart toggles

            utils: {
                formatCurrency: (v,d=0)=>!isNaN(v=parseFloat(v))?v.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:d,maximumFractionDigits:d}):'$0',
                formatPercent: (v,d=2)=>!isNaN(v=parseFloat(v))&&isFinite(v)?`${(v*100).toFixed(d)}%`:'N/A',
                formatNumber: v=>{let s=String(v||'').trim();if(!s)return'';s=s.replace(/,/g,'');const n=parseFloat(s);return isNaN(n)?'':n.toLocaleString('en-US');},
                parseNumber: v=>parseFloat(String(v||'').replace(/,/g,''))||0,
                parseString: v=>String(v||'').trim(),
                hexToRgba(hex, alpha) {
                    if (!hex || typeof hex !== 'string' || hex.charAt(0) !== '#') return `rgba(128, 128, 128, ${alpha})`;
                    const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                    if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(128, 128, 128, ${alpha})`;
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                }
            },

            url: {
                update(currentState) {
                    const diffState = Object.keys(currentState).reduce((acc, key) => {
                        if (App.config.dom.inputs[key] && String(currentState[key]) !== String(App.config.defaults[key])) {
                            acc[key] = currentState[key];
                        }
                        return acc;
                    }, {});

                    if (Object.keys(diffState).length > 0) {
                        const minState = Object.keys(diffState).reduce((acc, key) => {
                            if (App.config.URL_KEY_MAP[key]) {
                                acc[App.config.URL_KEY_MAP[key]] = diffState[key];
                            }
                            return acc;
                        }, {});
                        const urlData = LZString.compressToEncodedURIComponent(JSON.stringify(minState));
                        history.pushState(null, '', `${window.location.pathname}?data=${urlData}`);
                    } else {
                        history.pushState(null, '', window.location.pathname);
                    }
                },

                load() {
                    const data = new URLSearchParams(window.location.search).get('data');
                    if (!data) return null;

                    try {
                        const minState = JSON.parse(LZString.decompressFromEncodedURIComponent(data));
                        if (typeof minState !== 'object' || !minState) throw new Error('Invalid URL data');
                        
                        const R_MAP = Object.fromEntries(Object.entries(App.config.URL_KEY_MAP).map(([k, v]) => [v, k]));
                        const loadedState = {};
                        for (const key in minState) {
                            const sKey = R_MAP[key];
                            if (sKey && App.config.dom.inputs[sKey]) {
                                loadedState[sKey] = minState[key];
                            }
                        }
                        return loadedState;
                    } catch (e) {
                        console.error("Failed to load URL state:", e);
                        history.replaceState(null, '', window.location.pathname);
                        return null;
                    }
                }
            },

            calculator: {
                run(state) {
                    const results = {
                        metrics: { preTax: {}, afterTax: {} },
                        projections: [],
                        amortizationSchedule: [],
                        shared: {}
                    };

                    results.shared.downPaymentAmount = state.purchasePrice * (state.downPayment / 100);
                    results.shared.loanAmount = state.purchasePrice - results.shared.downPaymentAmount;
                    results.shared.totalCashNeeded = results.shared.downPaymentAmount + state.closingCosts + state.rehabCosts;
                    const totalProjectCost = state.purchasePrice + state.closingCosts + state.rehabCosts;
                    results.shared.forcedEquity = state.arv - totalProjectCost;
                    results.shared.totalMonthlyIncome = state.grossMonthlyRent + state.otherIncome;
                    const vacancyAmount = results.shared.totalMonthlyIncome * (state.vacancyPct / 100);
                    results.shared.incomeBreakdown = { 'Gross Rent': state.grossMonthlyRent, 'Other Income': state.otherIncome };
                    results.shared.effectiveMonthlyIncome = results.shared.totalMonthlyIncome - vacancyAmount;
                    const maintenanceAmount = results.shared.totalMonthlyIncome * (state.maintenancePct / 100);
                    const managementAmount = results.shared.totalMonthlyIncome * (state.managementPct / 100);
                    const capExAmount = state.useItemizedCapEx ? 0 : results.shared.totalMonthlyIncome * (state.capExPct / 100);
                    results.shared.monthlyOpEx = state.propTaxes + state.insurance + vacancyAmount + maintenanceAmount + managementAmount + capExAmount + state.hoa + state.otherExpenses;
                    const monthlyNOI = results.shared.effectiveMonthlyIncome - (results.shared.monthlyOpEx - vacancyAmount);
                    results.shared.noi = monthlyNOI * 12;
                    
                    const interestRate = state.loanType.startsWith('fixed') ? state.interestRate : state.loanType.startsWith('arm') ? state.initialInterestRate : state.marginInterestRate;
                    const monthlyInterestRate = (interestRate / 100) / 12;

                    // FIX: Declare y1Interest here to prevent ReferenceError
                    let y1Interest = 0; 
                    
                    if (state.loanType !== 'margin') {
                         results.shared.loanTermMonths = state.loanTerm * 12;
                         results.shared.monthlyPI = this.calculatePi(results.shared.loanAmount, monthlyInterestRate, results.shared.loanTermMonths);
                         results.shared.expenseBreakdown = { 'P&I': results.shared.monthlyPI, 'Taxes': state.propTaxes, 'Insurance': state.insurance, 'Vacancy': vacancyAmount, 'Maintenance': maintenanceAmount, 'Management': managementAmount, 'CapEx': capExAmount, 'HOA': state.hoa, 'Other': state.otherExpenses };
                         results.shared.cashReserves = (results.shared.monthlyPI + state.propTaxes + state.insurance) * 6;
                        results.shared.annualDebtService = results.shared.monthlyPI * 12;
                        results.metrics.preTax.monthlyCashFlow = monthlyNOI - results.shared.monthlyPI;

                        // Calculate Year 1 Interest for Fixed/ARM Loans
                        let bal = results.shared.loanAmount;
                        for (let m=0; m<12; m++) {
                            const interest = bal * monthlyInterestRate;
                            y1Interest += interest;
                            const principal = results.shared.monthlyPI - interest;
                            bal -= principal;
                        }

                    } else { // Margin Loan (Interest Only + Investor-Driven Paydown)
                        results.shared.monthlyInterestOnly = results.shared.loanAmount * monthlyInterestRate;
                        results.shared.monthlyMinDebtService = results.shared.monthlyInterestOnly; // Minimum required payment
                        
                        // Investor-Driven Paydown Logic for Year 1:
                        const profitAfterMinDebt = monthlyNOI - results.shared.monthlyMinDebtService;
                        // Use MinCashFlow as the threshold for 'excess profit'
                        const excessProfitForRepayment = Math.max(0, profitAfterMinDebt - (state.minCashFlow / 12)); // Divide annual target by 12
                        const principalRepayment = excessProfitForRepayment * (state.marginRepaymentPct / 100);
                        
                        results.shared.monthlyPI = results.shared.monthlyMinDebtService + principalRepayment; // Actual payment made
                        y1Interest = results.shared.monthlyInterestOnly * 12; // Year 1 interest is fixed at monthly interest * 12
                        
                        results.shared.expenseBreakdown = { 'Interest': results.shared.monthlyMinDebtService, 'Principal Paydown': principalRepayment, 'Taxes': state.propTaxes, 'Insurance': state.insurance, 'Vacancy': vacancyAmount, 'Maintenance': maintenanceAmount, 'Management': managementAmount, 'CapEx': capExAmount, 'HOA': state.hoa, 'Other': state.otherExpenses };
                        
                        results.shared.cashReserves = (results.shared.monthlyMinDebtService + state.propTaxes + state.insurance) * 6;
                        results.shared.annualDebtService = results.shared.monthlyMinDebtService * 12; // Use MINIMUM Debt Service (Interest Only) for DSCR
                        
                        results.metrics.preTax.monthlyCashFlow = monthlyNOI - results.shared.monthlyPI; // Actual cash flow includes voluntary paydown
                    }
                    
                    results.metrics.preTax.annualCashFlow = results.metrics.preTax.monthlyCashFlow * 12;
                    results.metrics.preTax.cocRoi = results.shared.totalCashNeeded > 0 ? results.metrics.preTax.annualCashFlow / results.shared.totalCashNeeded : (results.metrics.preTax.annualCashFlow > 0 ? Infinity : -Infinity);
                    
                    results.shared.capRate = state.purchasePrice > 0 ? results.shared.noi / state.purchasePrice : 0;
                    // DSCR calculation uses annual NOI and annual MINIMUM debt service (P&I or Interest Only)
                    const annualMinDebtService = results.shared.annualDebtService; 
                    results.shared.dscr = annualMinDebtService > 0 ? results.shared.noi / annualMinDebtService : (results.shared.noi > 0 ? Infinity : -Infinity);
                    results.shared.grm = (state.grossMonthlyRent * 12) > 0 ? state.purchasePrice / (state.grossMonthlyRent * 12) : 0;
                    results.shared.debtYield = results.shared.loanAmount > 0 ? results.shared.noi / results.shared.loanAmount : 0;
                    results.shared.ltv = state.purchasePrice > 0 ? results.shared.loanAmount / state.purchasePrice : 0;
                    const totalCost = state.purchasePrice + state.rehabCosts;
                    results.shared.ltc = totalCost > 0 ? results.shared.loanAmount / totalCost : 0;
                    results.shared.onePercentRule = state.purchasePrice > 0 ? results.shared.totalMonthlyIncome / state.purchasePrice : 0;
                    results.shared.fiftyPercentRule = results.shared.totalMonthlyIncome > 0 ? (results.shared.monthlyOpEx - vacancyAmount) / results.shared.totalMonthlyIncome : 0;

                    const depreciableBasis = state.purchasePrice * (1 - state.landValuePct / 100);
                    const annualDepreciation = depreciableBasis / 27.5;
                    
                    // Use calculated Y1 Interest (y1Interest) for tax calculation
                    const taxableIncome = results.shared.noi - y1Interest - annualDepreciation;
                    const taxImpact = taxableIncome * (state.marginalTaxRate / 100);
                    results.metrics.afterTax.annualCashFlow = results.metrics.preTax.annualCashFlow - taxImpact;
                    results.metrics.afterTax.monthlyCashFlow = results.metrics.afterTax.annualCashFlow / 12;
                    results.metrics.afterTax.cocRoi = results.shared.totalCashNeeded > 0 ? results.metrics.afterTax.annualCashFlow / results.shared.totalCashNeeded : (results.metrics.afterTax.annualCashFlow > 0 ? Infinity : -Infinity);

                    const cashFlowPass = results.metrics.preTax.monthlyCashFlow >= state.minCashFlow;
                    const cocPass = results.shared.totalCashNeeded > 0 ? (results.metrics.preTax.cocRoi >= (state.minCocRoi / 100)) : true;
                    const dscrPass = results.shared.dscr >= state.lenderDscrReq;
                    const forcedEquityPass = results.shared.forcedEquity >= state.minForcedEquity;
                    results.shared.verdict = { isGo: forcedEquityPass && cashFlowPass && cocPass && dscrPass, forcedEquityPass, cashFlowPass, cocPass, dscrPass };

                    results.projections = this.calculateProjections(state, results);
                    
                    if(results.shared.loanAmount > 0) {
                        results.amortizationSchedule = this.calculateAmortization(state, results);
                    }
                    
                    results.sp500 = this.calculateSp500EquivalentReturn(state.holdPeriod, results.shared.totalCashNeeded, state.capitalGainsTaxRate, state.sp500Return);
                    
                    if (results.projections.length > 0) {
                        // NEW: Calculate Average Annualized Return on Equity (ROE) over the hold period
                        const roeSum = results.projections.reduce((sum, p) => {
                            // Only include years where starting equity is > 0 and ROE is a valid number
                            if (p.equityAtStartOfYear > 0 && isFinite(p.afterTax.roe)) {
                                return sum + p.afterTax.roe;
                            }
                            return sum;
                        }, 0);
                        const validRoeYears = results.projections.filter(p => p.equityAtStartOfYear > 0 && isFinite(p.afterTax.roe)).length;
                        results.shared.averageRoe = validRoeYears > 0 ? roeSum / validRoeYears : 0;
                        
                        const finalYear = results.projections[results.projections.length - 1];
                        const salePrice = finalYear.propertyValue;
                        const sellingCosts = salePrice * (state.salesExpensesPct / 100);
                        const loanPayoff = finalYear.loanBalance;
                        // FIX: Use landValuePct for depreciation calculation
                        const totalDepreciation = finalYear.year * (depreciableBasis / 27.5);
                        const capitalGain = salePrice - sellingCosts - state.purchasePrice;
                        const depreciationRecapture = Math.min(Math.max(0, capitalGain), totalDepreciation);
                        const appreciationGain = capitalGain - depreciationRecapture;
                        const taxOnRecapture = depreciationRecapture * (state.marginalTaxRate / 100);
                        const taxOnAppreciation = appreciationGain > 0 ? appreciationGain * (state.capitalGainsTaxRate / 100) : 0;
                        const totalTaxOnSale = taxOnRecapture + taxOnAppreciation;
                        const netCashFromSale = salePrice - sellingCosts - loanPayoff - totalTaxOnSale;

                        const initialCashNeeded = results.shared.totalCashNeeded;
                        const cumulativeCashFlows = results.projections.map(p => p.afterTax.cumulativeCashFlow);
                        const lowestCumulativeCashFlow = Math.min(0, ...cumulativeCashFlows);
                        const additionalCapitalContributions = Math.abs(lowestCumulativeCashFlow < 0 ? lowestCumulativeCashFlow : 0);
                        const totalCapitalInvested = initialCashNeeded + additionalCapitalContributions;
                        // FIX: Correct "dead code" profit calculation
                        const trueNetProfit = (netCashFromSale + finalYear.afterTax.cumulativeCashFlow) - totalCapitalInvested;
                        const totalReturnOnCapital = totalCapitalInvested > 0 ? trueNetProfit / totalCapitalInvested : (trueNetProfit > 0 ? Infinity : -Infinity);
                        
                        results.shared.longTermReturn = totalCapitalInvested > 0 && totalReturnOnCapital > -1 ? Math.pow(1 + totalReturnOnCapital, 1 / state.holdPeriod) - 1 : (totalReturnOnCapital <= -1 ? -1 : 0);

                        results.shared.returnWaterfall = { 
                            appreciation: finalYear.propertyValue - state.purchasePrice,
                            loanPaydown: results.shared.loanAmount - finalYear.loanBalance,
                            cashFlow: finalYear.preTax.cumulativeCashFlow
                        };
                    } else {
                        results.shared.longTermReturn = 0;
                        results.shared.returnWaterfall = { appreciation: 0, loanPaydown: 0, cashFlow: 0 };
                    }   
                    
                    results.state = state;
                    return results;
                },

                calculatePi(loanAmount, monthlyInterestRate, loanTermMonths) {
                    if (loanAmount <= 0) return 0;
                    if (monthlyInterestRate <= 0) return loanTermMonths > 0 ? loanAmount / loanTermMonths : 0;
                    const pi = loanAmount * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, loanTermMonths)) / (Math.pow(1 + monthlyInterestRate, loanTermMonths) - 1);
                    return isFinite(pi) ? pi : 0;
                },
                
                calculateProjections(state, initialResults) {
                    let loanBalance = initialResults.shared.loanAmount;
                    let currentPropertyValue = state.purchasePrice;
                    let cumulativeCashFlow = 0, cumulativeAfterTaxCashFlow = 0, cumulativeDepreciation = 0;
                    let equityAtStartOfYear = currentPropertyValue - loanBalance;
                    let currentMonthlyIncome = initialResults.shared.totalMonthlyIncome;
                    let fixedMonthlyExpenses = state.propTaxes + state.insurance + state.hoa + state.otherExpenses;                    
                    const depreciableBasis = state.purchasePrice * (1 - state.landValuePct / 100);
                    const annualDepreciation = depreciableBasis / 27.5;
                    const maxYears = Math.min(Math.max(1, state.holdPeriod), 50);
                    const projections = [];

                    for (let year = 1; year <= maxYears; year++) {
                        let annualCashFlowYear = 0, annualAfterTaxCashFlowYear = 0, annualNOI = 0, annualDebtService = 0, annualInterestPaid = 0;
                        let monthlyPI, currentMonthlyInterestRate;

                        let itemizedCapExForYear = 0;
                        if (state.useItemizedCapEx) {
                            state.itemizedCapEx.forEach(item => {
                                if (parseInt(item.year) === year) {
                                    itemizedCapExForYear += item.cost;
                                }
                            });
                        }

                        if (state.loanType === 'margin') {
                            currentMonthlyInterestRate = (state.marginInterestRate / 100) / 12;
                        } else if (state.loanType.startsWith('arm')) {
                            const armAdjustmentYear = state.loanType === 'arm10' ? 10 : 7;
                            const rate = year > armAdjustmentYear ? state.adjustedInterestRate : state.initialInterestRate;
                            currentMonthlyInterestRate = (rate / 100) / 12;
                        } else {
                            currentMonthlyInterestRate = (state.interestRate / 100) / 12;
                        }

                        for (let month = 1; month <= 12; month++) {
                            const monthlyGross = currentMonthlyIncome;
                            const monthlyVacancy = monthlyGross * (state.vacancyPct / 100);
                            const monthlyMaintenance = monthlyGross * (state.maintenancePct / 100);
                            const monthlyManagement = monthlyGross * (state.managementPct / 100);
                            const monthlyCapEx = state.useItemizedCapEx ? 0 : (monthlyGross * (state.capExPct / 100));
                            const monthlyOpex = fixedMonthlyExpenses + monthlyMaintenance + monthlyManagement + monthlyCapEx;
                            const monthlyNOI = (monthlyGross - monthlyVacancy) - monthlyOpex;
                            annualNOI += monthlyNOI;
                            const interest = loanBalance * currentMonthlyInterestRate;
                            annualInterestPaid += interest;

                            if (state.loanType === 'margin') {
                                // Margin Loan: Interest Only + Investor-Driven Paydown from excess profit
                                const monthlyMinDebtService = interest;
                                
                                // Cash Flow AFTER required debt service (Interest Only)
                                const profitAfterMinDebt = monthlyNOI - monthlyMinDebtService; 
                                
                                // Investor's defined threshold for 'excess' profit
                                const excessProfitForRepayment = Math.max(0, profitAfterMinDebt - (state.minCashFlow / 12)); // Divide annual target by 12
                                
                                const principalPaid = excessProfitForRepayment * (state.marginRepaymentPct / 100);
                                monthlyPI = monthlyMinDebtService + principalPaid;
                                loanBalance -= principalPaid;
                            } else {
                                // Amortizing Loans (Fixed/ARM)
                                const remainingTerm = (state.loanTerm * 12) - ((year - 1) * 12 + (month - 1));
                                // This uses the correct remaining term to calculate PI for accurate principal paydown
                                monthlyPI = this.calculatePi(loanBalance, currentMonthlyInterestRate, remainingTerm);
                                const principal = monthlyPI - interest;
                                loanBalance -= principal;
                            }
                            
                            const monthlyCashFlow = monthlyNOI - monthlyPI;
                            annualCashFlowYear += monthlyCashFlow;
                            annualDebtService += monthlyPI;
                            if (loanBalance < 0) loanBalance = 0;
                        }

                        annualCashFlowYear -= itemizedCapExForYear;

                        const taxableIncome = annualNOI - annualInterestPaid - annualDepreciation;
                        const taxImpact = taxableIncome * (state.marginalTaxRate / 100);
                        annualAfterTaxCashFlowYear = annualCashFlowYear - taxImpact;

                        projections.push(this._createProjectionRow(state, year, {
                            propertyValue: currentPropertyValue, loanBalance, equityAtStartOfYear,
                            annualCashFlow: annualCashFlowYear, annualAfterTaxCashFlow: annualAfterTaxCashFlowYear,
                            cumulativeCashFlow, cumulativeAfterTaxCashFlow, cumulativeDepreciation,
                            initialCashNeeded: initialResults.shared.totalCashNeeded,
                            annualNOI, annualDebtService, annualInterestPaid, annualDepreciation, taxImpact
                        }));

                        cumulativeCashFlow += annualCashFlowYear;
                        cumulativeAfterTaxCashFlow += annualAfterTaxCashFlowYear;
                        cumulativeDepreciation += annualDepreciation;
                        equityAtStartOfYear = currentPropertyValue - loanBalance;
                        
                        currentPropertyValue *= (1 + state.annualValueGrowth / 100);
                        currentMonthlyIncome *= (1 + state.annualIncomeGrowth / 100);
                        fixedMonthlyExpenses *= (1 + state.annualExpenseGrowth / 100);
                    }
                    return projections;
                },

                _createProjectionRow(state, year, data) {
                    const { propertyValue, loanBalance, equityAtStartOfYear, annualCashFlow, annualAfterTaxCashFlow, cumulativeCashFlow, cumulativeAfterTaxCashFlow, cumulativeDepreciation, initialCashNeeded, annualInterestPaid, annualDepreciation, taxImpact, annualNOI, annualDebtService } = data;

                    const currentCumulativeCF = cumulativeCashFlow + annualCashFlow;
                    const sellingCosts = propertyValue * (state.salesExpensesPct / 100);
                    const preTaxFinalValue = (propertyValue - sellingCosts - loanBalance) + currentCumulativeCF;
                    const preTaxTotalProfit = preTaxFinalValue - initialCashNeeded;
                    const preTaxTotalROI = initialCashNeeded > 0 ? preTaxTotalProfit / initialCashNeeded : (preTaxTotalProfit > 0 ? Infinity : -Infinity);
                    const preTaxAnnualizedReturn = Math.pow(1 + preTaxTotalROI, 1 / year) - 1;

                    const currentCumulAfterTaxCF = cumulativeAfterTaxCashFlow + annualAfterTaxCashFlow;
                    const costBasis = state.purchasePrice;
                    const totalDepreciation = cumulativeDepreciation + annualDepreciation;
                    const adjustedBasis = costBasis - totalDepreciation;
                    const capitalGain = propertyValue - sellingCosts - costBasis;
                    const depreciationRecapture = Math.min(Math.max(0, capitalGain), totalDepreciation);
                    const appreciationGain = capitalGain - depreciationRecapture;
                    const taxOnSale = (depreciationRecapture * (state.marginalTaxRate / 100)) + (appreciationGain > 0 ? appreciationGain * (state.capitalGainsTaxRate / 100) : 0);
                    const afterTaxFinalValue = (propertyValue - sellingCosts - loanBalance - taxOnSale) + currentCumulAfterTaxCF;
                    const afterTaxTotalProfit = afterTaxFinalValue - initialCashNeeded;
                    const afterTaxTotalROI = initialCashNeeded > 0 ? afterTaxTotalProfit / initialCashNeeded : (afterTaxTotalProfit > 0 ? Infinity : -Infinity);
                    const afterTaxAnnualizedReturn = Math.pow(1 + afterTaxTotalROI, 1 / year) - 1;

                    const inflationRate = state.inflationRate / 100;
                    const realTotalROI = ((1 + afterTaxTotalROI) / Math.pow(1 + inflationRate, year)) - 1;
                    const realAnnualizedReturn = Math.pow(1 + realTotalROI, 1 / year) - 1;

                    return {
                        year, propertyValue, equity: propertyValue - loanBalance, loanBalance: loanBalance > 0 ? loanBalance : 0,
                        annualInterestPaid, taxImpact, annualDepreciation,
                        annualNOI, annualDebtService,
                        preTax: {
                            cashFlow: annualCashFlow,
                            cumulativeCashFlow: currentCumulativeCF,
                            profitIfSold: preTaxTotalProfit,
                            annualizedReturn: isFinite(preTaxAnnualizedReturn) ? preTaxAnnualizedReturn : 0,
                            roe: equityAtStartOfYear > 0 ? annualCashFlow / equityAtStartOfYear : Infinity,
                        },
                        afterTax: {
                            cashFlow: annualAfterTaxCashFlow,
                            cumulativeCashFlow: currentCumulAfterTaxCF,
                            profitIfSold: afterTaxTotalProfit,
                            annualizedReturn: isFinite(afterTaxAnnualizedReturn) ? afterTaxAnnualizedReturn : 0,
                            realAnnualizedReturn: isFinite(realAnnualizedReturn) ? realAnnualizedReturn : 0,
                            roe: equityAtStartOfYear > 0 ? annualAfterTaxCashFlow / equityAtStartOfYear : Infinity,
                        }
                    };
                },

                calculateAmortization(state, initialResults) {
                    const schedule = [];
                    let balance = initialResults.shared.loanAmount;
                    let termInMonths, monthlyInterestRateFn;

                    if (state.loanType === 'margin') {
                        termInMonths = state.holdPeriod * 12;
                        monthlyInterestRateFn = () => (state.marginInterestRate / 100) / 12;
                    } else {
                        termInMonths = state.loanTerm * 12;
                        monthlyInterestRateFn = (month) => {
                            if (state.loanType.startsWith('arm')) {
                                const armAdjustmentYear = state.loanType === 'arm10' ? 10 : 7;
                                const rate = (month / 12) > armAdjustmentYear ? state.adjustedInterestRate : state.initialInterestRate;
                                return (rate / 100) / 12;
                            }
                            return (state.interestRate / 100) / 12;
                        };
                    }

                    for (let month = 1; month <= termInMonths; month++) {
                        const monthlyInterestRate = monthlyInterestRateFn(month);
                        const interest = balance * monthlyInterestRate;
                        let principal, payment;

                        if (state.loanType === 'margin') {
                             // This is a simplified projection for the chart; real margin repayment is variable.
                             // We'll use a fixed payment based on year 1 for chart stability.
                            payment = initialResults.shared.monthlyPI;
                            principal = payment - interest;
                        } else {
                            payment = this.calculatePi(balance, monthlyInterestRate, termInMonths - month + 1);
                            principal = payment - interest;
                        }

                        balance -= principal;
                        
                        schedule.push({
                            month,
                            payment,
                            principal: principal > 0 ? principal : 0,
                            interest: interest > 0 ? interest : 0,
                            endingBalance: balance < 0.01 ? 0 : balance,
                        });
                        
                        if (balance <= 0) break;
                    }
                    return schedule;
                },
                
                calculateSp500EquivalentReturn(holdPeriod, initialInvestment, capitalGainsTaxRate, expectedReturn) {
                   if (initialInvestment <= 0 || holdPeriod <= 0) return { finalValue: 0, totalProfit: 0, annualizedReturn: 0 };
                   
                   const annualReturnDecimal = expectedReturn / 100;
                   const finalValue = initialInvestment * Math.pow(1 + annualReturnDecimal, holdPeriod);

                   const preTaxProfit = finalValue - initialInvestment;
                   const taxOnProfit = preTaxProfit > 0 ? preTaxProfit * (capitalGainsTaxRate / 100) : 0;
                   const afterTaxProfit = preTaxProfit - taxOnProfit;

                   const afterTaxFinalValue = initialInvestment + afterTaxProfit;
                   const afterTaxTotalRoi = afterTaxProfit / initialInvestment;
                   const annualizedReturn = afterTaxTotalRoi > -1 ? Math.pow(1 + afterTaxTotalRoi, 1 / holdPeriod) - 1 : -1;
                   
                   return { finalValue: afterTaxFinalValue, totalProfit: afterTaxProfit, annualizedReturn };
               },

               calculateIRR(cashflows, guess = 0.1) {
                    const maxIterations = 100;
                    const tolerance = 1e-7;
                    let irr = guess;
                    for (let i = 0; i < maxIterations; i++) {
                        let npv = 0, derivative = 0;
                        for (let t = 0; t < cashflows.length; t++) {
                            npv += cashflows[t] / Math.pow(1 + irr, t);
                            if (t > 0) derivative -= t * cashflows[t] / Math.pow(1 + irr, t + 1);
                        }
                        if (Math.abs(npv) < tolerance) return irr;
                        if (derivative === 0) return NaN;
                        irr -= npv / derivative;
                    }
                    return NaN; // Failed to converge
               },

               calculateMoIC(cashflows) {
                    const totalInvested = cashflows.filter(cf => cf < 0).reduce((sum, cf) => sum + cf, 0);
                    const totalReturned = cashflows.filter(cf => cf > 0).reduce((sum, cf) => sum + cf, 0);
                    if (totalInvested === 0) return Infinity;
                    return totalReturned / Math.abs(totalInvested);
                },

                calculateMonthlyProjections(state, initialResults) {
                    const projections = [];
                    const monthlyIncomeGrowth = Math.pow(1 + state.annualIncomeGrowth / 100, 1 / 12) - 1;
                    const monthlyExpenseGrowth = Math.pow(1 + state.annualExpenseGrowth / 100, 1 / 12) - 1;
                    const monthlyValueGrowth = Math.pow(1 + state.annualValueGrowth / 100, 1 / 12) - 1;
                    const depreciableBasis = state.purchasePrice * (1 - state.landValuePct / 100);
                    const monthlyDepreciation = depreciableBasis / (27.5 * 12);

                    let current = {
                        loanBalance: initialResults.shared.loanAmount,
                        propertyValue: state.purchasePrice,
                        grossMonthlyRent: state.grossMonthlyRent,
                        otherIncome: state.otherIncome,
                        propTaxes: state.propTaxes,
                        insurance: state.insurance,
                        hoa: state.hoa,
                        otherExpenses: state.otherExpenses,
                        cumulativeAfterTaxCF: 0,
                        totalCapitalInvested: initialResults.shared.totalCashNeeded
                    };
                    
                    const armAdjustmentMonth = (state.loanType === 'arm10' ? 10 : 7) * 12;

                    for (let month = 1; month <= 360; month++) {
                        const p = {};
                        const beginningEquity = current.propertyValue - current.loanBalance;

                        // I. Income
                        p.grossScheduledRent = current.grossMonthlyRent;
                        p.otherIncome = current.otherIncome;
                        p.grossPotentialIncome = p.grossScheduledRent + p.otherIncome;
                        p.vacancyLoss = p.grossPotentialIncome * (state.vacancyPct / 100);
                        p.effectiveGrossIncome = p.grossPotentialIncome - p.vacancyLoss;

                        // II. Operating Expenses
                        p.propTaxes = current.propTaxes;
                        p.insurance = current.insurance;
                        p.hoa = current.hoa;
                        p.otherFixedExpenses = current.otherExpenses;
                        p.repairs = p.grossPotentialIncome * (state.maintenancePct / 100);
                        p.management = p.grossPotentialIncome * (state.managementPct / 100);
                        p.totalOpEx = p.propTaxes + p.insurance + p.hoa + p.otherFixedExpenses + p.repairs + p.management;
                        
                        // III. Profitability & Debt Service
                        p.noi = p.effectiveGrossIncome - p.totalOpEx;
                        let monthlyInterestRate;
                        if (state.loanType.startsWith('arm')) {
                            const rate = month > armAdjustmentMonth ? state.adjustedInterestRate : state.initialInterestRate;
                            monthlyInterestRate = (rate / 100) / 12;
                        } else {
                            monthlyInterestRate = (state.interestRate / 100) / 12;
                        }
                        const remainingTerm = (state.loanTerm * 12) - (month - 1);
                        p.debtService = this.calculatePi(current.loanBalance, monthlyInterestRate, remainingTerm);
                        p.interestPayment = current.loanBalance * monthlyInterestRate;
                        p.principalPayment = p.debtService - p.interestPayment;
                        const yearOfMonth = Math.ceil(month / 12);
                        const itemizedCapExForYear = state.useItemizedCapEx ? (state.itemizedCapEx.filter(item => parseInt(item.year) === yearOfMonth).reduce((sum, item) => sum + item.cost, 0)) : 0;
                        const capExReserve = state.useItemizedCapEx ? 0 : p.grossPotentialIncome * (state.capExPct / 100);
                        p.capEx = capExReserve + (itemizedCapExForYear / 12);
                        p.cashFlowBeforeTax = p.noi - p.debtService - p.capEx;

                        // IV. After-Tax Analysis
                        p.depreciation = monthlyDepreciation;
                        p.taxableIncome = p.noi - p.interestPayment - p.depreciation;
                        p.taxImpact = p.taxableIncome * (state.marginalTaxRate / 100);
                        p.cashFlowAfterTax = p.cashFlowBeforeTax - p.taxImpact;

                        // V. Balance Sheet & Equity
                        p.beginningLoanBalance = current.loanBalance;
                        current.loanBalance -= p.principalPayment;
                        if (current.loanBalance < 0) current.loanBalance = 0;
                        p.endingLoanBalance = current.loanBalance;
                        p.propertyValue = current.propertyValue;
                        p.totalEquity = p.propertyValue - p.endingLoanBalance;

                        // VI. KPIs & Cumulative
                        current.cumulativeAfterTaxCF += p.cashFlowAfterTax;
                        p.cumulativeAfterTaxCF = current.cumulativeAfterTaxCF;
                        if (p.cashFlowAfterTax < 0) {
                            current.totalCapitalInvested -= p.cashFlowAfterTax;
                        }
                        p.totalCapitalInvested = current.totalCapitalInvested;
                        p.dscr = p.debtService > 0 ? p.noi / p.debtService : Infinity;
                        p.roe = beginningEquity > 0 ? (p.cashFlowAfterTax * 12) / beginningEquity : Infinity;

                        projections.push(p);

                        // Increment values for the next month
                        current.propertyValue *= (1 + monthlyValueGrowth);
                        current.grossMonthlyRent *= (1 + monthlyIncomeGrowth);
                        current.otherIncome *= (1 + monthlyIncomeGrowth);
                        current.propTaxes *= (1 + monthlyExpenseGrowth);
                        current.insurance *= (1 + monthlyExpenseGrowth);
                        current.hoa *= (1 + monthlyExpenseGrowth);
                        current.otherExpenses *= (1 + monthlyExpenseGrowth);
                    }
                    return projections;
                },
            },

            ui: {
                _tooltipEl: null,
                setInputsToDefault() {
                    for (const key in App.config.defaults) {
                        if (key === 'investmentStrategy') {
                            const radio = document.querySelector(`input[name="investmentStrategy"][value="${App.config.defaults[key]}"]`);
                            if (radio) radio.checked = true;
                        } else {
                            const element = document.getElementById(App.config.dom.inputs[key]);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = App.config.defaults[key];
                                } else {
                                    element.value = App.config.defaults[key];
                                }
                            }
                        }
                    }
                },

                applyState(stateToApply) {
                    for (const key in stateToApply) {
                        if (key === 'itemizedCapEx') {
                            // Special handling for the itemized list
                            App.renderItemizedCapEx(stateToApply[key]);
                        } else if (key === 'investmentStrategy') {
                            const radio = document.querySelector(`input[name="investmentStrategy"][value="${stateToApply[key]}"]`);
                            if (radio) radio.checked = true;
                        } 
                        else if (App.config.dom.inputs[key]) {
                            const element = document.getElementById(App.config.dom.inputs[key]);
                            if (element) {
                                if(element.type === 'checkbox') {
                                    element.checked = stateToApply[key];
                                } else {
                                    element.value = stateToApply[key];
                                }
                            }
                        }
                    }
                    
                    const loadedLoanType = document.getElementById(App.config.dom.inputs.loanType).value;
                    App.events.toggleLoanInputs(loadedLoanType);
                },

                update(results) {
                    const outputContainer = document.getElementById(App.config.dom.outputs.outputContainer);
                    if (outputContainer && !document.getElementById(App.config.dom.outputs.showdownCard)) {
                        this.renderInitialOutputLayout(outputContainer);
                    }
                    // NEW: Ensure the selector is populated when results arrive
                    this.renderProjectionsDataSelector();
                    this.updateVerdict(results);
                    this.updateStrategicInsights(results);
                    this.updateKeyMetrics(results);
                    this.updateProjectionsTable(results);
                    this.updateSaleAnalysis(results);

                    setTimeout(() => {
                        this.updateBreakdownChart(results);
                        this.updateAmortizationChart(results);
                        this.updateWealthProjectionChart(results);
                        this.updateOptimalExitChart(results);
                        this.updateReturnWaterfallChart(results);
                        this.updateWealthSourcesSummary(results); // FIX: Move this call INSIDE the setTimeout block
                    }, 0);
                },

                renderProjectionsDataSelector() {
                    const selector = document.getElementById(App.config.dom.outputs.projectionsDataSelector);
                    if (!selector) return;

                    const dataFields = [
                        { key: 'propertyValue', label: 'Prop. Value', currency: true, rate: false, defaultSelected: true, color: App.config.colors.strategy.valueadd },
                        { key: 'equity', label: 'Total Equity', currency: true, rate: false, defaultSelected: false, color: App.utils.hexToRgba(App.config.colors.strategy.valueadd, 0.7) },
                        { key: 'loanBalance', label: 'Loan Balance', currency: true, rate: false, defaultSelected: false, color: App.config.colors.status.dark },
                        { key: 'afterTax.cashFlow', label: 'After-Tax CF', currency: true, rate: false, defaultSelected: true, color: App.config.colors.strategy.cashflow },
                        { key: 'preTax.cashFlow', label: 'Pre-Tax CF', currency: true, rate: false, defaultSelected: false, color: App.utils.hexToRgba(App.config.colors.strategy.cashflow, 0.5) },
                        { key: 'afterTax.roe', label: 'Return on Equity (ROE)', currency: false, rate: true, defaultSelected: false, color: App.config.colors.strategy.appreciation },
                        { key: 'afterTax.annualizedReturn', label: 'Annualized Return (IRR)', currency: false, rate: true, defaultSelected: false, color: App.config.colors.chart.primary[4] },
                        { key: 'annualNOI', label: 'Annual NOI', currency: true, rate: false, defaultSelected: false, color: App.config.colors.chart.primary[5] },
                        { key: 'annualInterestPaid', label: 'Interest Paid', currency: true, rate: false, defaultSelected: false, color: App.config.colors.chart.primary[6] },
                        { key: 'taxImpact', label: 'Tax Impact', currency: true, rate: false, defaultSelected: false, color: App.config.colors.chart.primary[7] },
                    ];

                    // Cache for use in the chart update function
                    this._projectionsDataFields = dataFields; 
                    
                    if (selector.options.length === 0) {
                        selector.innerHTML = dataFields.map(f => 
                            `<option value="${f.key}" data-currency="${f.currency}" data-rate="${f.rate}" style="color: ${f.color}" ${f.defaultSelected ? 'selected' : ''}>${f.label}</option>`
                        ).join('');
                    }
                },

                updateProjectionsChart(results) {
                    const { projections } = results;
                    const selector = document.getElementById(App.config.dom.outputs.projectionsDataSelector);
                    const chartEl = document.getElementById(App.config.dom.outputs.projectionsChart);
                    if (!selector || !chartEl || !projections || projections.length === 0) return;
                    const ctx = chartEl.getContext('2d');
                    
                    if (App.charts.projections) App.charts.projections.destroy();
                    
                    const labels = projections.map(p => `Year ${p.year}`);
                    const selectedOptions = Array.from(selector.options).filter(opt => opt.selected);
                    
                    // Helper to safely get nested property value
                    const getValue = (obj, path) => {
                        return path.split('.').reduce((o, i) => (o ? o[i] : 0), obj);
                    };

                    const datasets = selectedOptions.map((opt, i) => {
                        const isRate = opt.dataset.rate === 'true';
                        const field = this._projectionsDataFields.find(f => f.key === opt.value);
                        
                        return {
                            label: opt.text,
                            data: projections.map(p => getValue(p, opt.value)),
                            borderColor: field ? field.color : App.config.colors.chart.primary[i],
                            backgroundColor: field ? App.utils.hexToRgba(field.color, 0.2) : App.config.colors.chart.primary[i],
                            yAxisID: isRate ? 'yRate' : 'yCurrency',
                            type: 'line',
                            fill: false,
                            tension: 0.2,
                            borderWidth: 3,
                            pointRadius: 3
                        };
                    });

                    App.charts.projections = new Chart(ctx, {
                        type: 'line', 
                        data: { labels, datasets }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            interaction: { mode: 'index', intersect: false },
                            plugins: { 
                                legend: { position: 'bottom', labels: { usePointStyle: true, boxHeight: 8 } }, 
                                datalabels: { display: false },
                                tooltip: { 
                                    mode: 'index', 
                                    intersect: false, 
                                    callbacks: { 
                                        label: c => {
                                            const isRate = c.dataset.yAxisID === 'yRate';
                                            return `${c.dataset.label}: ${isRate ? App.utils.formatPercent(c.raw) : App.utils.formatCurrency(c.raw, 0)}`;
                                        }
                                    } 
                                }
                            }, 
                            scales: {
                                x: { grid: { display: false } },
                                yCurrency: {
                                    type: 'linear', position: 'left', title: { display: true, text: 'Value ($)' },
                                    ticks: { callback: v => App.utils.formatCurrency(v, 0) },
                                    grid: { color: '#e5e7eb' }, 
                                },
                                yRate: {
                                    type: 'linear', position: 'right', title: { display: true, text: 'Rate (%)' },
                                    ticks: { callback: v => App.utils.formatPercent(v, 0) },
                                    grid: { drawOnChartArea: false }, 
                                }
                            }
                        }
                    });
                },

                renderInitialOutputLayout(container) {
                     container.innerHTML = `
                        <div id="executive-dashboard" class="space-y-6">
                            
                            <div id="showdownCard" class="p-6 bg-white rounded-xl shadow-sm border-2 border-slate-200" style="border-color: var(--strategy-color);">
                                <h2 class="text-2xl font-bold text-slate-900">Investment Showdown: Property vs. S&P 500</h2>
                                <p class="text-sm text-slate-600 mt-1">A true "apples-to-apples" comparison to answer the question: what's the best use of your capital?</p>
                                <div class="mt-4 overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                            <tr>
                                                <th class="px-4 py-2">Metric</th>
                                                <th class="px-4 py-2 text-center">This Property</th>
                                                <th class="px-4 py-2 text-center">S&P 500</th>
                                            </tr>
                                        </thead>
                                        <tbody id="showdownTableBody" class="divide-y divide-slate-200">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="showdownVerdict" class="mt-4 p-4 rounded-lg bg-slate-50 border border-slate-200 text-sm text-slate-800">
                                </div>
                            </div>

                            <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-y-3">
                                    <h2 class="text-2xl font-semibold text-slate-900">Executive Performance</h2>
                                    <div class="flex flex-col sm:flex-row items-end gap-3 text-sm">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-slate-600" id="timeToggleLabelYear1">Year 1</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timeHorizonToggle" class="sr-only">
                                                <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                            </label>
                                            <span class="font-semibold text-slate-800" id="timeToggleLabelFullPeriod">Full Period (IRR)</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-slate-600">Pre-Tax</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="taxStatusToggle" class="sr-only">
                                                <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                            </label>
                                            <span class="font-semibold text-slate-800">After-Tax</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                                    <div data-metric="headlineCashFlow" class="p-4 rounded-lg col-span-2 lg:col-span-2 order-1 lg:order-1 border border-slate-200">
                                        <p class="metric-label text-sm text-slate-600">
                                            <span class="tooltip-container justify-center" data-tooltip="The cash generation metric. Shows Monthly Cash Flow (Year 1) or Total Net Profit (Full Period).">
                                                <span id="cashFlowTypeLabel">Monthly Cash Flow</span> 
                                                <span id="cashFlowPeriodLabel" class="font-semibold">Year 1, Pre-Tax</span> 
                                                <span class="help-icon">?</span>
                                            </span>
                                        </p>
                                        <p id="headlineCashFlow" class="metric-value text-3xl font-bold"></p>
                                        <p id="headlineCashFlowBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                    </div>
                                    <div data-metric="headlineRoi" class="p-4 rounded-lg col-span-2 lg:col-span-2 order-2 lg:order-2 border border-slate-200">
                                        <p class="metric-label text-sm text-slate-600">
                                            <span class="tooltip-container justify-center" data-tooltip="The rate of return metric. Shows Cash-on-Cash ROI (Year 1) or Internal Rate of Return (Full Period).">
                                                <span id="roiTypeLabel">Cash-on-Cash ROI</span> 
                                                <span id="roiPeriodLabel" class="font-semibold">Year 1, Pre-Tax</span> 
                                                <span class="help-icon">?</span>
                                            </span>
                                        </p>
                                        <p id="headlineRoi" class="metric-value text-3xl font-bold"></p>
                                        <p id="headlineRoiBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                    </div>
                                </div>
                                <div class="mt-6 p-4 rounded-lg bg-slate-50 border border-slate-200">
                                    <div class="flex justify-between items-center mb-3">
                                        <div>
                                            <h3 class="font-semibold text-slate-800">Property Viability Checklist</h3>
                                            <p class="text-xs text-slate-500">Compares Year 1 pre-tax results to your criteria.</p>
                                        </div>
                                        <span id="verdictBadge" class="text-lg font-bold px-3 py-1 rounded-md"></span>
                                    </div>
                                    <ul id="verdictChecklist" class="space-y-2 text-slate-700 text-sm"></ul>
                                </div>
                            </div>
                        </div>


                        <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-2xl font-semibold text-slate-900 mb-4">Quick Screeners & Rules of Thumb</h2>
                            <div id="quick-ratios-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                                <div data-metric="onePercentRule" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Does the monthly rent meet or exceed 1% of the purchase price? A classic quick check for cash flow potential.">1% Rule <span class="help-icon">?</span></span></p>
                                    <p id="onePercentRule" class="metric-value text-lg font-semibold"></p>
                                    <p id="onePercentRuleBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="fiftyPercentRule" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Are your operating expenses (excluding mortgage) around 50% of your income? A classic sanity check on your expense projections.">50% Rule <span class="help-icon">?</span></span></p>
                                    <p id="fiftyPercentRule" class="metric-value text-lg font-semibold"></p>
                                    <p id="fiftyPercentRuleBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="grm" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Gross Rent Multiplier. A rough measure of a property's value relative to its income.">GRM <span class="help-icon">?</span></span></p>
                                    <p id="grm" class="metric-value text-lg font-semibold"></p>
                                    <p id="grmBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                            </div>
                        </div>


                        <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-2xl font-semibold text-slate-900 mb-4">Property Financial Engine</h2>
                            <p class="text-sm text-slate-600 mb-4">Core metrics that define the asset's unleveraged profitability and growth potential. Priorities are highlighted based on the selected strategy.</p>

                            <div id="property-financial-engine-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                                
                                <div data-metric="totalCashNeeded" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="The total amount of cash you need to bring to closing. Denominator for CoC ROI.">Total Cash Needed <span class="help-icon">?</span></span></p>
                                    <p id="totalCashNeeded" class="metric-value text-lg font-semibold"></p>
                                    <p id="totalCashNeededBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="noi" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Net Operating Income. The property's annual engine, independent of debt.">NOI (Annual) <span class="help-icon">?</span></span></p>
                                    <p id="noi" class="metric-value text-lg font-semibold"></p>
                                    <p id="noiBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="capRate" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Capitalization Rate. Unleveraged market return (NOI / Price).">Cap Rate <span class="help-icon">?</span></span></p>
                                    <p id="capRate" class="metric-value text-lg font-semibold"></p>
                                    <p id="capRateBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="forcedEquity" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="The equity created immediately upon purchase and renovation (ARV - Total Cost).">Forced Equity <span class="help-icon">?</span></span></p>
                                    <p id="forcedEquity" class="metric-value text-lg font-semibold"></p>
                                    <p id="forcedEquityBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="averageRoe" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Annualized Return on Equity. Average efficiency of your trapped equity over the hold period.">Avg. Annual ROE <span class="help-icon">?</span></span></p>
                                    <p id="averageRoe" class="metric-value text-lg font-semibold"></p>
                                    <p id="averageRoeBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-2xl font-semibold text-slate-900 mb-4">Debt and Safety Analysis</h2>
                            <div id="risk-ratios-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                                <div data-metric="dscr" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Debt Service Coverage Ratio. Shows if the property's income can cover its debt payments. Lender typically requires > 1.25.">DSCR <span class="help-icon">?</span></span></p>
                                    <p id="dscr" class="metric-value text-lg font-semibold"></p>
                                    <p id="dscrBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="debtYield" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="A measure of the lender's risk. The return they would receive if they had to foreclose. Often requires 10% or higher.">Debt Yield <span class="help-icon">?</span></span></p>
                                    <p id="debtYield" class="metric-value text-lg font-semibold"></p>
                                    <p id="debtYieldBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="ltvLtc" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="Ratios lenders use to assess risk against the property's value (LTV) and total project cost (LTC).">LTV / LTC <span class="help-icon">?</span></span></p>
                                    <p id="ltvLtc" class="metric-value text-lg font-semibold"></p>
                                    <p id="ltvLtcBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                                <div data-metric="cashReserves" class="p-4 rounded-lg border border-slate-200">
                                    <p class="metric-label text-sm text-slate-600"><span class="tooltip-container justify-center" data-tooltip="A recommended safety net to cover 6 months of core housing expenses (PITI) in case of vacancy or unexpected issues.">Cash Reserves <span class="help-icon">?</span></span></p>
                                    <p id="cashReserves" class="metric-value text-lg font-semibold"></p>
                                    <p id="cashReservesBreakdown" class="metric-breakdown text-xs text-slate-500"></p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                                <h2 class="text-2xl font-semibold text-slate-900 mb-1">Sources of Wealth</h2>
                                <p class="text-sm text-slate-600 mb-4"><span class="tooltip-container" data-tooltip="This chart shows how your initial investment grows into your final equity. It visualizes the three engines of real estate wealth creation: cash flow (income), loan paydown (forced savings), and appreciation (market growth).">
                                    How your initial equity is built up over the hold period.
                                    <span class="help-icon">?</span>
                                </span></p>
                                <div id="profitBreakdownSummary" class="mb-6 p-4 bg-slate-50 border border-slate-200"></div>
                                <div class="h-72 relative">
                                    <canvas id="returnWaterfallChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                                <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                                    <h2 class="text-2xl font-semibold text-slate-900 flex items-center">
                                        Long-Term Wealth Projection
                                        <span class="tooltip-container ml-2" data-tooltip="<strong>How to Read This Chart:</strong><br><ul class='list-disc pl-4 mt-1 space-y-1'><li>The <strong style='color: #2E7D32'>Property Value Area</strong> shows the total projected value of the asset over time.</li><li>The <strong style='color: #A0A0A0'>Loan Balance Area</strong> within it shows how much is still owed.</li><li>The green area between the two lines is your <strong>Equity</strong>.</li><li>The <strong style='color: #1565C0'>Cash Flow Line</strong> shows your yearly income, plotted on the right-hand axis for clarity. Use the toggle to see the impact of taxes.</li></ul>">
                                            <span class="help-icon">?</span>
                                        </span>
                                    </h2>
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span class="text-slate-600">Pre-Tax</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="wealthChartToggle" class="sr-only">
                                            <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                        </label>
                                        <span class="font-semibold text-slate-800">After-Tax</span>
                                    </div>
                                </div>
                                <p class="text-sm text-slate-600 mb-4">Visualize your wealth growth over time. Track how your Equity (the green area) grows as the Loan is paid down against the total Property Value.</p>
                                <div class="h-96 relative">
                                    <canvas id="wealthProjectionChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                                <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                                    <h2 class="text-2xl font-semibold text-slate-900 flex items-center">
                                        Optimal Exit Analysis
                                        <span class="tooltip-container ml-2" data-tooltip="<strong>How to Read This Chart:</strong><br><ul class='list-disc pl-4 mt-1 space-y-1'><li>The <strong>Profit Bars</strong> show the total net profit you would realize if you sold in that year. Use the toggle to see the impact of capital gains taxes.</li><li>The <strong style='color: #6A1B9A'>Annualized Return Line</strong> represents your total return on investment, averaged per year. The peak of this line, marked with a dashed line, is generally the most profitable year to exit.</li><li>The <strong style='color: #1565C0'>Return on Equity (ROE) Dotted Line</strong> shows how efficiently your trapped equity is working. A declining ROE signals it may be time to sell or refinance to redeploy your capital into a new, higher-performing asset.</li></ul>">
                                            <span class="help-icon">?</span>
                                        </span>
                                    </h2>
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span class="text-slate-600">Pre-Tax</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="exitChartToggle" class="sr-only">
                                            <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                        </label>
                                        <span class="font-semibold text-slate-800">After-Tax</span>
                                    </div>
                                </div>
                                <p class="text-sm text-slate-600 mb-4">Identify the best time to sell or refinance by comparing total profit growth against your investment's performance (Annualized Return) and equity efficiency (ROE).</p>
                                <div class="h-96 relative">
                                    <canvas id="optimalExitChart"></canvas>
                                </div>
                            </div>

                            <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-x-4 gap-y-2">
                                    <h2 class="text-2xl font-semibold text-slate-900">Monthly Breakdown</h2>
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span id="breakdownToggleLabelExpense" class="font-semibold text-slate-800">Expenses</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="breakdownToggle" class="sr-only">
                                            <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                        </label>
                                        <span id="breakdownToggleLabelIncome" class="text-slate-600">Income</span>
                                    </div>
                                    <p id="breakdownTotal" class="flex-grow text-right text-2xl font-bold text-slate-800"></p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                                    <div class="h-64 relative">
                                        <canvas id="expenseChart"></canvas>
                                    </div>
                                    <div id="expenseLegend" class="text-sm space-y-2"></div>
                                </div>
                            </div>
                            
                            <div class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                                 <h2 class="text-2xl font-semibold text-slate-900 flex items-center mb-4">
                                    Debt & Amortization
                                    <span class="tooltip-container ml-2" data-tooltip="<strong>How to Read This Chart:</strong><br><ul class='list-disc pl-4 mt-1 space-y-1'><li><strong>Fixed/ARM Loans:</strong> Shows your growing **Equity** (green area) as the **Loan Balance** (gray area) is paid down by amortization.</li><li><strong>Margin Loans:</strong> Shows the Loan Balance decline driven by your **Investor-Driven Paydown** strategy (using excess profit), alongside the cost of interest and equity growth.</li></ul>">
                                        <span class="help-icon">?</span>
                                    </span>
                                </h2>
                                <div class="h-96 relative">
                                    <canvas id="amortizationChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div id="saleAnalysisCard" class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-2xl font-semibold text-slate-900 mb-4">Sale Analysis (End of Year <span id="saleAnalysisYear"></span>)</h2>
                            <div id="saleAnalysisContent" class="space-y-3 text-sm">
                                </div>
                        </div>

                        <div id="analysisOverTimeContainer" class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-y-2">
                                <h2 class="text-2xl font-semibold text-slate-900">Analysis Over Time</h2>
                                <div class="flex items-center space-x-2 text-sm">
                                    <span class="text-slate-600">Table View</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="projectionsChartToggle" class="sr-only">
                                        <div class="toggle-switch-track"><span class="toggle-switch-thumb"></span></div>
                                    </label>
                                    <span class="font-semibold text-slate-800">Chart View</span>
                                </div>
                            </div>
                            
                            <div id="analysisChartContainer" class="hidden space-y-4">
                                <div class="flex flex-wrap items-center gap-4">
                                    <span class="text-sm font-medium text-slate-700">Select Metrics to Plot:</span>
                                    <select id="projectionsDataSelector" multiple size="6" class="block w-full max-w-sm rounded-md shadow-sm sm:text-sm bg-slate-50 border-slate-300">
                                        <optgroup label="Returns & Cash Flow">
                                            <option value="afterTax.cashFlow" data-currency="true" data-rate="false">After-Tax CF</option>
                                            <option value="afterTax.roe" data-currency="false" data-rate="true">Return on Equity (ROE)</option>
                                            <option value="afterTax.annualizedReturn" data-currency="false" data-rate="true">Annualized Return (IRR)</option>
                                            <option value="preTax.cashFlow" data-currency="true" data-rate="false">Pre-Tax CF</option>
                                        </optgroup>
                                        <optgroup label="Asset & Debt">
                                            <option value="propertyValue" data-currency="true" data-rate="false">Prop. Value</option>
                                            <option value="equity" data-currency="true" data-rate="false">Total Equity</option>
                                            <option value="loanBalance" data-currency="true" data-rate="false">Loan Balance</option>
                                            <option value="annualInterestPaid" data-currency="true" data-rate="false">Interest Paid</option>
                                            <option value="annualNOI" data-currency="true" data-rate="false">Annual NOI</option>
                                        </optgroup>
                                        <optgroup label="Tax & Profit">
                                            <option value="taxImpact" data-currency="true" data-rate="false">Tax Impact</option>
                                            <option value="afterTax.profitIfSold" data-currency="true" data-rate="false">After-Tax Profit</option>
                                            <option value="afterTax.realAnnualizedReturn" data-currency="false" data-rate="true">Real Ann. Return</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="h-96 relative">
                                    <canvas id="projectionsChart"></canvas>
                                </div>
                            </div>

                            <div id="projectionsTableWrapper" class="table-wrapper">
                                <table class="w-full text-sm text-left whitespace-nowrap">
                                    <thead class="text-xs text-slate-700 uppercase bg-slate-200">
                                        <tr>
                                            <th><div class="px-4 py-3 tooltip-container" data-tooltip="The year of the projection."><span>Yr</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="Projected market value at year end."><span>Prop. Value</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="Total mortgage interest paid during the year. This is a tax-deductible expense."><span>Interest Paid</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="The non-cash expense for wear and tear, which reduces your taxable income."><span>Depreciation</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="The net tax liability (positive) or savings (negative) for the year, based on your marginal tax rate."><span>Tax Impact</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="Pre-tax annual cash flow."><span>Pre-Tax CF</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="After-tax annual cash flow. This is your true take-home profit for the year."><span>After-Tax CF</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="Return on Equity, using after-tax cash flow. (After-Tax CF / Equity at Start of Year)."><span>ROE</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="Total net profit if you sold that year, after all costs and taxes."><span>After-Tax Profit</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="The geometric average annual return, after taxes, if you sold in this year."><span>Ann. Return</span><span class="help-icon">?</span></div></th>
                                            <th class="text-right"><div class="px-4 py-3 tooltip-container justify-end" data-tooltip="The annualized return adjusted for inflation, showing the real growth in your purchasing power."><span>Real Ann. Return</span><span class="help-icon">?</span></div></th>
                                        </tr>
                                    </thead>
                                    <tbody id="projectionsTable" class="divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                    `;
                   // Attach event listeners to the newly created output elements
                   App.events.setupOutputListeners();
                },

                _setMetric(id, value, breakdown) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                        const parentCard = el.closest('[data-metric]');
                        if(parentCard) {
                            const breakdownDisplay = parentCard.querySelector('.metric-breakdown');
                            if(breakdownDisplay) {
                                breakdownDisplay.innerHTML = breakdown ? `<span class='text-slate-400'>=</span> ${breakdown}` : '';
                            }
                        }
                    }
                },
               
                updateWealthSourcesSummary(results) {
                    const { shared, state, projections } = results;
                    const { formatCurrency } = App.utils;
                    const { colors } = App.config;
                    const summaryEl = document.getElementById('profitBreakdownSummary');
                    if (!summaryEl || projections.length === 0) return;

                    const finalYear = projections[projections.length - 1];

                    const components = [
                        { name: 'Total Cash Flow', value: finalYear.preTax.cumulativeCashFlow, color: colors.strategy.cashflow, icon: '💰' },
                        { name: 'Loan Paydown', value: shared.loanAmount - finalYear.loanBalance, color: colors.strategy.valueadd, icon: '🏦' },
                        { name: 'Appreciation', value: finalYear.propertyValue - state.purchasePrice, color: colors.strategy.appreciation, icon: '📈' }
                    ];

                    const totalProfit = components.reduce((sum, c) => sum + c.value, 0);

                    const componentCardsHTML = components.map(comp => `
                        <div class="flex items-center p-3 bg-white rounded-lg border border-slate-200 shadow-sm">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white text-lg" style="background-color:${comp.color}">${comp.icon}</div>
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-slate-700">${comp.name}</p>
                                <p class="text-lg font-semibold ${comp.value >= 0 ? 'text-slate-900' : 'text-red-600'}">${formatCurrency(comp.value)}</p>
                            </div>
                        </div>`).join('');

                    summaryEl.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-slate-800">Pre-Tax Profit Breakdown</h3> 
                            <div class="text-right">
                                <div class="text-sm text-slate-600 tooltip-container justify-end" data-tooltip="The property's raw earning power, calculated <strong>before</strong> taxes and selling costs. <br><br><strong>Formula:</strong> (Appreciation + Loan Paydown + Pre-Tax Cash Flow).">Total Pre-Tax Profit <span class="help-icon">?</span></div>
                                <div class="text-xl font-bold ${totalProfit >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(totalProfit)}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">${componentCardsHTML}</div>`;
                },

                updateVerdict(results) {
                    const { dom } = App.config;
                    const { formatCurrency, formatPercent } = App.utils;
                    const { metrics, shared, state, sp500, projections } = results;
                    const { verdict } = shared;

                    // --- 1. Handle the well-styled Viability Checklist ---
                    const badgeEl = document.getElementById('verdictBadge');
                    const checklistEl = document.getElementById('verdictChecklist');

                    if (badgeEl && checklistEl) {
                        // Set the main verdict badge
                        if (verdict.isGo) {
                            badgeEl.textContent = 'GO';
                            badgeEl.className = 'text-lg font-bold px-3 py-1 rounded-md bg-green-100 text-green-800';
                        } else {
                            badgeEl.textContent = 'NO-GO';
                            badgeEl.className = 'text-lg font-bold px-3 py-1 rounded-md bg-red-100 text-red-800';
                        }

                        // Define the checklist items
                        const checklistItems = [
                            { label: 'Forced Equity', rule: `≥ ${formatCurrency(state.minForcedEquity)}`, actual: formatCurrency(shared.forcedEquity), pass: verdict.forcedEquityPass },
                            { label: 'Pre-Tax CF', rule: `≥ ${formatCurrency(state.minCashFlow)}/mo`, actual: formatCurrency(metrics.preTax.monthlyCashFlow), pass: verdict.cashFlowPass },
                            { label: 'Pre-Tax CoC', rule: `≥ ${state.minCocRoi}%`, actual: formatPercent(metrics.preTax.cocRoi), pass: verdict.cocPass },
                            { label: 'DSCR', rule: `≥ ${state.lenderDscrReq.toFixed(2)}`, actual: shared.dscr.toFixed(2), pass: verdict.dscrPass }
                        ];

                        // Generate the HTML for the list
                        checklistEl.innerHTML = checklistItems.map(item => {
                            const icon = item.pass
                                ? `<svg class="w-5 h-5 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
                                : `<svg class="w-5 h-5 text-red-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                            return `
                                <li class="flex items-center justify-between p-2 rounded-md transition-colors hover:bg-slate-100">
                                    <div class="flex items-center gap-2">
                                        ${icon}
                                        <span class="font-medium text-slate-800">${item.label}</span>
                                        <span class="text-xs text-slate-500">${item.rule}</span>
                                    </div>
                                    <span class="font-semibold ${item.pass ? 'text-slate-900' : 'text-red-700'}">${item.actual}</span>
                                </li>`;
                        }).join('');
                    }

                    // --- 2. Correctly Calculate IRR and Showdown Metrics (with bug fix) ---
                    const finalYear = projections[projections.length - 1];
                    const salePrice = finalYear.propertyValue;
                    const sellingCosts = salePrice * (state.salesExpensesPct / 100);
                    const loanPayoff = finalYear.loanBalance;
                    const totalDepreciation = finalYear.year * (state.purchasePrice * (1 - state.landValuePct / 100) / 27.5);
                    const capitalGain = salePrice - sellingCosts - state.purchasePrice;
                    const depreciationRecapture = Math.min(Math.max(0, capitalGain), totalDepreciation);
                    const appreciationGain = capitalGain - depreciationRecapture;
                    const taxOnRecapture = depreciationRecapture * (state.marginalTaxRate / 100);
                    const taxOnAppreciation = appreciationGain > 0 ? appreciationGain * (state.capitalGainsTaxRate / 100) : 0;
                    const totalTaxOnSale = taxOnRecapture + taxOnAppreciation;
                    const netCashFromSale = salePrice - sellingCosts - loanPayoff - totalTaxOnSale;
                    const initialCashNeeded = shared.totalCashNeeded;
                    const cumulativeCashFlows = projections.map(p => p.afterTax.cumulativeCashFlow);
                    const lowestCumulativeCashFlow = Math.min(0, ...cumulativeCashFlows);
                    const additionalCapitalContributions = Math.abs(lowestCumulativeCashFlow < 0 ? lowestCumulativeCashFlow : 0);
                    const propertyTotalCapital = initialCashNeeded + additionalCapitalContributions;
                    const allCashFlowsExceptLast = projections.slice(0, -1).map(p => p.afterTax.cashFlow);
                    const finalYearTotalInflow = finalYear.afterTax.cashFlow + netCashFromSale;
                    const propertyCashFlows = [ -initialCashNeeded, ...allCashFlowsExceptLast, finalYearTotalInflow ];

                    const propertyIRR = App.calculator.calculateIRR(propertyCashFlows) || 0;
                    const propertyMoIC = App.calculator.calculateMoIC(propertyCashFlows) || 0;
                    const propertyProfit = finalYear.afterTax.profitIfSold;
                    const sp500CashFlows = [-shared.totalCashNeeded, ...Array(state.holdPeriod - 1).fill(0), sp500.finalValue];
                    const sp500IRR = App.calculator.calculateIRR(sp500CashFlows) || 0;
                    const sp500MoIC = App.calculator.calculateMoIC(sp500CashFlows) || 0;

                    // --- 3. Populate the Investment Showdown Table & Verdict ---
                    const showdownTableBody = document.getElementById('showdownTableBody');
                    if (showdownTableBody) {
                        const createRow = (metric, propValue, spValue, formatter, helpText) => {
                            const propWin = propValue > spValue;
                            const spWin = spValue > propValue;
                            return `<tr class="text-base"><td class="px-4 py-3 font-semibold text-slate-800"><span class="tooltip-container" data-tooltip="${helpText}">${metric}<span class="help-icon">?</span></span></td><td class="px-4 py-2 text-center text-lg font-bold ${propWin ? 'text-green-600' : ''}">${formatter(propValue)}</td><td class="px-4 py-2 text-center text-lg font-bold ${spWin ? 'text-green-600' : ''}">${formatter(spValue)}</td></tr>`;
                        };
                        showdownTableBody.innerHTML = 
                            createRow('IRR (Internal Rate of Return)', propertyIRR, sp500IRR, v => formatPercent(v), "The 'true' annualized return, considering all cash flows over time. This is the best metric for an apples-to-apples comparison.") +
                            createRow('Total After-Tax Profit', propertyProfit, sp500.totalProfit, v => formatCurrency(v), "The absolute amount of money you make after all costs and taxes.") +
                            createRow('MoIC (Multiple on Invested Capital)', propertyMoIC, sp500MoIC, v => `${v.toFixed(2)}x`, "How many dollars you get back for every dollar invested. A MoIC of 2.5x means you got back $2.50 for every $1 you put in.") +
                            createRow('Total Capital Invested', propertyTotalCapital, shared.totalCashNeeded, v => formatCurrency(v), "The total cash out-of-pocket required over the entire hold period. Includes initial investment and any years with negative cash flow.");
                    }

                    const showdownVerdictEl = document.getElementById('showdownVerdict');
                    if (showdownVerdictEl) {
                        let verdictHTML = '<span class="font-semibold">Verdict:</span> ';
                        if (propertyIRR > sp500IRR && propertyProfit > sp500.totalProfit) {
                            verdictHTML += `The <strong class="text-green-700">Property appears to be the superior investment</strong>, showing a higher time-adjusted return (IRR) and generating more total profit.`;
                        } else if (sp500IRR > propertyIRR && sp500.totalProfit > propertyProfit) {
                            verdictHTML += `The <strong class="text-blue-700">S&P 500 appears to be the superior investment</strong>, offering a better return for less complexity.`;
                        } else {
                            verdictHTML += `It's a mixed result. The <strong>${propertyIRR > sp500IRR ? 'Property' : 'S&P 500'}</strong> shows a better rate of return (IRR), while the <strong>${propertyProfit > sp500.totalProfit ? 'Property' : 'S&P 500'}</strong> generates more absolute profit. Your choice depends on your primary goal: rate of return vs. total dollars.`;
                        }
                        showdownVerdictEl.innerHTML = verdictHTML;
                    }
                },

                updateSaleAnalysis(results) {
                    const { projections, state, shared } = results;
                    const { formatCurrency, formatPercent } = App.utils;
                    const yearEl = document.getElementById('saleAnalysisYear');
                    const contentEl = document.getElementById('saleAnalysisContent');
                    const cardEl = document.getElementById('saleAnalysisCard');

                    if (!yearEl || !contentEl || !cardEl || projections.length === 0) {
                        if(cardEl) cardEl.classList.add('hidden');
                        return;
                    }
                    cardEl.classList.remove('hidden');

                    const finalYear = projections[projections.length - 1];
                    
                    const salePrice = finalYear.propertyValue;
                    const sellingCosts = salePrice * (state.salesExpensesPct / 100);
                    const loanPayoff = finalYear.loanBalance;
                    const totalDepreciation = finalYear.year * (state.purchasePrice * (1 - state.landValuePct / 100) / 27.5);
                    
                    const capitalGain = salePrice - sellingCosts - state.purchasePrice;
                    const depreciationRecapture = Math.min(Math.max(0, capitalGain), totalDepreciation);
                    const appreciationGain = capitalGain - depreciationRecapture;
                    
                    const taxOnRecapture = depreciationRecapture * (state.marginalTaxRate / 100);
                    const taxOnAppreciation = appreciationGain > 0 ? appreciationGain * (state.capitalGainsTaxRate / 100) : 0;
                    const totalTaxOnSale = taxOnRecapture + taxOnAppreciation;
                    
                    const netCashFromSale = salePrice - sellingCosts - loanPayoff - totalTaxOnSale;

                    const initialCashNeeded = shared.totalCashNeeded;
                    const cumulativeCashFlows = projections.map(p => p.afterTax.cumulativeCashFlow);
                    const lowestCumulativeCashFlow = Math.min(0, ...cumulativeCashFlows);
                    const additionalCapitalContributions = Math.abs(lowestCumulativeCashFlow < 0 ? lowestCumulativeCashFlow : 0);
                    const totalCapitalInvested = initialCashNeeded + additionalCapitalContributions;
                    const capitalInvestedTooltip = `This is the total out-of-pocket cash invested.<br><br>
                        &bull; Initial Investment (Day 1): ${formatCurrency(initialCashNeeded, 0)}<br>
                        &bull; Capital for Shortfalls: + ${formatCurrency(additionalCapitalContributions, 0)}<br>
                        <strong>&bull; Total Invested: ${formatCurrency(totalCapitalInvested, 0)}</strong>`;
                    const trueNetProfit = (netCashFromSale + finalYear.afterTax.cumulativeCashFlow) - totalCapitalInvested; // <-- FIX: Added cumulative cash flow to the calculation
                    const totalReturnOnCapital = totalCapitalInvested > 0 ? trueNetProfit / totalCapitalInvested : (trueNetProfit > 0 ? Infinity : -Infinity); // FIX: Added cumulative cash flow to the calculation
                    const annualizedReturnOnCapital = totalCapitalInvested > 0 && totalReturnOnCapital > -1 ? Math.pow(1 + totalReturnOnCapital, 1 / state.holdPeriod) - 1 : (totalReturnOnCapital <= -1 ? -1 : 0);

                    yearEl.textContent = finalYear.year;
                    
                    contentEl.innerHTML = `
                        <div class="flex justify-between items-center py-2 border-b border-slate-200">
                            <span class="text-slate-600">Future Sale Price</span>
                            <span class="font-semibold">${formatCurrency(salePrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-200">
                            <span class="text-slate-600">Less: Selling Costs (${state.salesExpensesPct}%)</span>
                            <span class="font-semibold text-red-600">-${formatCurrency(sellingCosts)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-slate-200">
                            <span class="text-slate-600">Less: Loan Payoff</span>
                            <span class="font-semibold text-red-600">-${formatCurrency(loanPayoff)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-slate-600">Less: Total Tax on Sale</span>
                            <span class="font-semibold text-red-600">-${formatCurrency(totalTaxOnSale)}</span>
                        </div>
                        <div class="pl-4 text-xs text-slate-500 space-y-1 border-b border-slate-200 pb-2">
                            <div class="flex justify-between items-center">
                                <span>Depreciation Recapture Tax</span>
                                <span>-${formatCurrency(taxOnRecapture)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Capital Gains Tax</span>
                                <span>-${formatCurrency(taxOnAppreciation)}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center py-2 mt-2">
                            <span class="font-semibold">Net Cash from Sale</span>
                            <span class="font-bold text-lg">${formatCurrency(netCashFromSale)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t mt-3 border-slate-200">
                            <span class="text-slate-600 tooltip-container" data-tooltip="${capitalInvestedTooltip}">Total Capital Invested <span class="help-icon">?</span></span>
                            <span class="font-semibold text-red-600">-${formatCurrency(totalCapitalInvested)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-t mt-2 border-slate-200">
                            <span class="font-semibold tooltip-container" data-tooltip="Your final, bottom-line profit after all taxes and expenses. <br><br><strong>Formula:</strong> (Net Cash from Sale + All Cumulative Cash Flow) - (Total Capital Invested). <br><br>This is the same headline 'After-Tax Profit' shown in the 'Investment Showdown' card.">
                                📊 True Net Profit
                                <span class="help-icon">?</span>
                            </span>
                            <span class="font-bold text-xl ${trueNetProfit >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(trueNetProfit)}</span>
                        </div>
                        <div class="text-right text-xs text-slate-500 -mt-1">
                            <span>Total: <strong>${formatPercent(totalReturnOnCapital, 1)}</strong> (${formatPercent(annualizedReturnOnCapital, 1)} annualized)</span>
                        </div>
                    `;
                },

                updateStrategicInsights({ state }) {
                    const { strategyThemes, strategyHighlights } = App.config;
                    const strategy = state.investmentStrategy;
                    const theme = strategyThemes[strategy];

                    if (!theme) return;

                    const root = document.documentElement;
                    root.style.setProperty('--strategy-color', theme.cssVar);
                    root.style.setProperty('--strategy-color-alpha', theme.alpha);

                    document.querySelectorAll('.strategy-option').forEach(el => {
                        const input = el.querySelector('input');
                        if (input) {
                            el.classList.toggle('strategy-selected', input.value === strategy);
                            if (input.value === strategy) input.checked = true;
                        }
                    });
                    
                    const hexColor = getComputedStyle(document.documentElement).getPropertyValue(theme.cssVar.replace('var(','').replace(')','')).trim();
                    
                    // FIX: This section was referencing strategyHighlights as a local variable 
                    // that was not correctly defined in the previous steps. It should be 
                    // correctly scoped via destructuring (which we already did) but 
                    // needed the logic to access the strategy value.
                    const highlightMetrics = strategyHighlights[strategy] || [];
                    
                    const allMetrics = Array.from(document.querySelectorAll('#property-financial-engine-grid [data-metric]'));
                    
                    // 1. Reset all metrics
                    allMetrics.forEach(el => {
                        el.classList.remove('metric-highlight');
                        el.style.order = ''; // Reset order
                        el.style.backgroundColor = '';
                        el.style.borderColor = '';
                    });
                    
                    // 2. Highlight and set order for strategic metrics
                    if (allMetrics.length > 0) {
                         highlightMetrics.forEach((metricId, index) => {
                            const el = document.querySelector(`#property-financial-engine-grid [data-metric="${metricId}"]`);
                            if (el) {
                                el.classList.add('metric-highlight');
                                // Assign the lowest order numbers to the highlight metrics
                                el.style.order = index.toString(); 
                                el.style.backgroundColor = App.utils.hexToRgba(hexColor, 0.05);
                                el.style.borderColor = App.utils.hexToRgba(hexColor, 0.4);
                            }
                        });
                        // Set the order for non-highlighted metrics to be high (e.g., 100) so they flow after the prioritized ones
                        allMetrics.forEach(el => {
                            if (!el.classList.contains('metric-highlight')) {
                                el.style.order = '100';
                            }
                        });
                    }
                },

                updateKeyMetrics(results) {
                    const { formatCurrency, formatPercent } = App.utils;
                    const { metrics, shared, state, projections } = results;
                    
                    const isTimeFull = document.getElementById(App.config.dom.toggles.timeHorizonToggle).checked;
                    const isTaxAfter = document.getElementById(App.config.dom.toggles.taxStatusToggle).checked;

                    const metricColor = (val) => val >= 0 ? 'text-green-600' : 'text-red-600';
                    const finalYear = projections[projections.length - 1] || {};
                    const totalProfit = isTaxAfter ? (finalYear.afterTax?.profitIfSold || 0) : (finalYear.preTax?.profitIfSold || 0);
                    const annualizedReturn = isTaxAfter ? (finalYear.afterTax?.annualizedReturn || 0) : (finalYear.preTax?.annualizedReturn || 0);

                    // --- Dynamic Headline Metrics ---

                    let headlineCF, headlineROI, cfType, roiType, cfBreakdown, roiBreakdown, cfPeriod, roiPeriod;

                    if (isTimeFull) { // Full Period (IRR & Total Profit)
                        headlineCF = totalProfit;
                        headlineROI = annualizedReturn; // This uses the IRR proxy (Annualized Return)
                        cfType = 'Total Net Profit';
                        roiType = 'Internal Rate of Return (IRR)';
                        cfPeriod = isTaxAfter ? 'After-Tax' : 'Pre-Tax'; // Removed redundant parentheses
                        roiPeriod = cfPeriod;
                        cfBreakdown = `${formatCurrency(finalYear.afterTax?.cumulativeCashFlow || 0, 0)} + Net Sale Proceeds`;
                        roiBreakdown = `Avg Annual Rate over ${state.holdPeriod} years`;
                    } else { // Year 1 (Cash Flow & CoC ROI)
                        const cfMetric = isTaxAfter ? metrics.afterTax.monthlyCashFlow : metrics.preTax.monthlyCashFlow;
                        const roiMetric = isTaxAfter ? metrics.afterTax.cocRoi : metrics.preTax.cocRoi;
                        headlineCF = cfMetric;
                        headlineROI = roiMetric;
                        cfType = 'Monthly Cash Flow';
                        roiType = 'Cash-on-Cash ROI';
                        cfPeriod = isTaxAfter ? 'After-Tax' : 'Pre-Tax'; // Removed redundant parentheses
                        roiPeriod = cfPeriod;

                        if (isTaxAfter) {
                            const taxSavings = (metrics.preTax.monthlyCashFlow - metrics.afterTax.monthlyCashFlow);
                            cfBreakdown = `${formatCurrency(metrics.preTax.monthlyCashFlow,0)} + ${formatCurrency(-taxSavings,0)} (Tax Shield)`;
                            roiBreakdown = `${formatCurrency(metrics.afterTax.annualCashFlow,0)} / ${formatCurrency(shared.totalCashNeeded,0)}`;
                        } else {
                            cfBreakdown = `${formatCurrency(shared.noi/12,0)} - ${formatCurrency(shared.monthlyPI,0)}`;
                            roiBreakdown = `${formatCurrency(metrics.preTax.annualCashFlow,0)} / ${formatCurrency(shared.totalCashNeeded,0)}`;
                        }
                    }

                    // Apply Dynamic Headline Values
                    document.getElementById(App.config.dom.outputs.cashFlowTypeLabel).textContent = cfType;
                    document.getElementById(App.config.dom.outputs.cashFlowPeriodLabel).textContent = cfPeriod;
                    document.getElementById(App.config.dom.outputs.roiTypeLabel).textContent = roiType;
                    document.getElementById(App.config.dom.outputs.roiPeriodLabel).textContent = roiPeriod;

                    document.getElementById(App.config.dom.outputs.headlineCashFlow).className = `metric-value text-3xl font-bold ${metricColor(headlineCF)}`;
                    this._setMetric('headlineCashFlow', isTimeFull ? formatCurrency(headlineCF) : formatCurrency(headlineCF), cfBreakdown);

                    document.getElementById(App.config.dom.outputs.headlineRoi).className = `metric-value text-3xl font-bold ${metricColor(headlineROI)}`;
                    this._setMetric('headlineRoi', isTimeFull ? formatPercent(headlineROI) : formatPercent(headlineROI), roiBreakdown);


                    // --- Fixed Metrics (Set once, used in multiple cards) ---

                    this._setMetric('noi', formatCurrency(shared.noi), `${formatCurrency(shared.effectiveMonthlyIncome*12,0)} - ${formatCurrency(shared.monthlyOpEx*12,0)}`);
                    this._setMetric('capRate', formatPercent(shared.capRate), `${formatCurrency(shared.noi,0)} / ${formatCurrency(state.purchasePrice,0)}`);
                    this._setMetric('totalCashNeeded', formatCurrency(shared.totalCashNeeded), `${formatCurrency(shared.downPaymentAmount, 0)} + ${formatCurrency(state.closingCosts, 0)} + ${formatCurrency(state.rehabCosts, 0)}`);
                    this._setMetric('cashReserves', formatCurrency(shared.cashReserves, 0), `6mo of P+I+T+I`);
                    this._setMetric('forcedEquity', formatCurrency(shared.forcedEquity), `${formatCurrency(state.arv,0)} - ${formatCurrency(state.purchasePrice + state.closingCosts + state.rehabCosts,0)}`);
                    this._setMetric('dscr', shared.dscr.toFixed(2), `${formatCurrency(shared.noi,0)} / ${formatCurrency(shared.annualDebtService,0)}`);
                    this._setMetric('grm', shared.grm.toFixed(2), `${formatCurrency(state.purchasePrice,0)} / ${formatCurrency(state.grossMonthlyRent * 12,0)}`);
                    this._setMetric('onePercentRule', formatPercent(shared.onePercentRule, 2), `${formatCurrency(state.grossMonthlyRent,0)} / ${formatCurrency(state.purchasePrice,0)}`);
                    this._setMetric('fiftyPercentRule', formatPercent(shared.fiftyPercentRule, 1), `${formatCurrency(shared.monthlyOpEx,0)} / ${formatCurrency(shared.totalMonthlyIncome,0)}`);
                    this._setMetric('debtYield', formatPercent(shared.debtYield, 2), `${formatCurrency(shared.noi,0)} / ${formatCurrency(shared.loanAmount,0)}`);
                    this._setMetric('ltvLtc', `${formatPercent(shared.ltv, 1)} / ${formatPercent(shared.ltc, 1)}`, `LTV / LTC`);
                    this._setMetric('averageRoe', formatPercent(shared.averageRoe), `Avg. After-Tax CF / Equity`);
                    
                    // Call updateStrategy after setting all metrics to ensure correct highlighting and ordering
                    this.updateStrategicInsights({ state });
                },

                updateBreakdownChart({ shared }) {
                    const { colors } = App.config;
                    const { formatCurrency, formatPercent, hexToRgba } = App.utils;
                    const chartElement = document.getElementById('expenseChart');
                    const legendEl = document.getElementById('expenseLegend');
                    const totalEl = document.getElementById('breakdownTotal');
                    const toggleEl = document.getElementById('breakdownToggle');
                    const expenseLabel = document.getElementById('breakdownToggleLabelExpense');
                    const incomeLabel = document.getElementById('breakdownToggleLabelIncome');

                    if (!chartElement || !legendEl || !totalEl || !toggleEl || !expenseLabel || !incomeLabel) return;

                    const showIncome = toggleEl.checked;

                    expenseLabel.className = showIncome ? 'text-slate-600' : 'font-semibold text-slate-800';
                    incomeLabel.className = showIncome ? 'font-semibold text-slate-800' : 'text-slate-600';

                    const breakdown = showIncome ? shared.incomeBreakdown : shared.expenseBreakdown;
                    const total = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
                    totalEl.textContent = formatCurrency(total);
                    
                    const ctx = chartElement.getContext('2d');
                    const sortedBreakdown = Object.entries(breakdown).sort(([, a], [, b]) => b - a);
                    const labels = sortedBreakdown.map(([key]) => key);
                    const data = sortedBreakdown.map(([, value]) => value);
                    
                    const chartColors = showIncome 
                        ? [colors.strategy.valueadd, colors.strategy.appreciation] 
                        : colors.chart.primary;
                    
                    const backgroundColors = chartColors.map(c => App.utils.hexToRgba(c, 0.75));

                    legendEl.innerHTML = labels.map((label, i) => `
                        <div class="flex items-center justify-between py-1 px-2 rounded hover:bg-slate-100 transition-colors cursor-pointer group expense-legend-item" data-index="${i}">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2 shadow-sm" style="background-color: ${chartColors[i % chartColors.length]}"></div>
                                <span class="text-xs font-medium text-slate-700">${label}</span>
                            </div>
                            <div class="text-right">
                                <span class="font-semibold text-slate-900 text-xs">${formatCurrency(data[i])}</span>
                                <span class="text-slate-500 text-xs ml-1 legend-pct"></span>
                            </div>
                        </div>`).join('');
                    
                    const updatePercentages = () => {
                        const chart = App.charts.expense;
                        if (!chart) return;
                        const dataset = chart.data.datasets[0];
                        let visibleTotal = 0;
                        dataset.data.forEach((val, i) => { if (chart.getDataVisibility(i)) visibleTotal += val; });
                        legendEl.querySelectorAll('.expense-legend-item').forEach((item) => {
                            const pctEl = item.querySelector('.legend-pct');
                            const index = parseInt(item.dataset.index, 10);
                            if (chart.getDataVisibility(index)) {
                                pctEl.textContent = `(${formatPercent(visibleTotal > 0 ? (dataset.data[index] / visibleTotal) : 0, 1)})`;
                            } else {
                                pctEl.textContent = '';
                            }
                        });
                    };
                    
                    document.querySelectorAll('.expense-legend-item').forEach(item => {
                        item.onclick = () => {
                            const index = item.dataset.index, chart = App.charts.expense;
                            if(chart) {
                                chart.toggleDataVisibility(index);
                                item.style.opacity = chart.getDataVisibility(index) ? '1' : '0.5';
                                item.querySelector('span').classList.toggle('line-through', !chart.getDataVisibility(index));
                                chart.update();
                                updatePercentages();
                            }
                        };
                    });
                    
                    if (App.charts.expense) {
                        App.charts.expense.data.labels = labels;
                        App.charts.expense.data.datasets[0].data = data;
                        App.charts.expense.data.datasets[0].backgroundColor = backgroundColors;
                        App.charts.expense.update('none');
                    } else {
                        App.charts.expense = new Chart(ctx, {
                            type: 'doughnut', 
                            data: { labels, datasets: [{ data, backgroundColor: backgroundColors, borderWidth: 2, borderColor: '#ffffff' }] },
                            options: { responsive: true, maintainAspectRatio: false, cutout: '60%', layout: { padding: 20 }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.raw)}` } }, datalabels: { display: false } } }
                        });
                    }
                    updatePercentages();
                },
                
                // FIX: Replace entire function with improved "Sources of Wealth" waterfall chart
                updateReturnWaterfallChart({ shared, state, projections }) {
                    const { dom, colors } = App.config;
                    const { formatCurrency } = App.utils;
                    
                    const chartEl = document.getElementById(dom.charts.profitWaterfallChart);
                    if (!chartEl || projections.length === 0) return;
                    const ctx = chartEl.getContext('2d');
                    if (App.charts.profitWaterfall) App.charts.profitWaterfall.destroy();

                    const finalYear = projections[projections.length - 1];
                    const initialEquity = shared.downPaymentAmount + state.rehabCosts;
                    const totalCashFlow = finalYear.preTax.cumulativeCashFlow;
                    const loanPaydown = shared.loanAmount - finalYear.loanBalance;
                    const appreciation = finalYear.propertyValue - state.purchasePrice;

                    const dataPoints = [
                        { label: 'Initial Equity', value: initialEquity, color: colors.status.dark },
                        { label: 'Total Cash Flow', value: totalCashFlow, color: colors.strategy.cashflow },
                        { label: 'Loan Paydown', value: loanPaydown, color: colors.strategy.valueadd },
                        { label: 'Appreciation', value: appreciation, color: colors.strategy.appreciation },
                    ];

                    const labels = [...dataPoints.map(d => d.label), 'Final Equity'];
                    const data = [];
                    let runningTotal = 0;

                    dataPoints.forEach(dp => {
                        data.push([runningTotal, runningTotal + dp.value]);
                        runningTotal += dp.value;
                    });

                    data.push([0, runningTotal]);

                    App.charts.profitWaterfall = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [...dataPoints.map(d => App.utils.hexToRgba(d.color, 0.75)), App.utils.hexToRgba(colors.status.positive, 0.85)],
                                barPercentage: 0.8
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { 
                                    callbacks: { 
                                        label: c => {
                                            const isTotalBar = c.dataIndex === c.dataset.data.length - 1;
                                            const diff = isTotalBar ? c.raw[1] : c.raw[1] - c.raw[0];
                                            return `${c.chart.data.labels[c.dataIndex]}: ${formatCurrency(diff, 0)}`;
                                        }
                                    } 
                                },
                                datalabels: {
                                    display: true,
                                    align: (context) => {
                                        const isLastComponentBar = context.dataIndex === context.dataset.data.length - 2;
                                        return isLastComponentBar ? 'start' : 'end';
                                    },
                                    anchor: 'end',
                                    color: (context) => {
                                        return context.dataIndex === context.dataset.data.length - 2 ? '#f1f5f9' : '#334155';
                                     },
                                    font: { weight: 'semibold' },
                                    formatter: (value, context) => {
                                        const isTotalBar = context.dataIndex === context.dataset.data.length - 1;
                                        const barData = context.dataset.data[context.dataIndex];
                                        const diff = isTotalBar ? barData[1] : barData[1] - barData[0];
                                        return formatCurrency(diff, 0);
                                    }
                                }
                            },
                            scales: { 
                                y: { ticks: { callback: v => formatCurrency(v, 0) }, 
                                // FIX 3: Add 15% padding to the top of the Y-axis to prevent the final label from being cut off
                                max: runningTotal * 1.15 } 
                            }
                        }
                    });
                },
                
                updateWealthProjectionChart(results) {
                    const { dom, colors } = App.config;
                    const { formatCurrency, hexToRgba } = App.utils;
                    const { projections } = results;
                    const chartEl = document.getElementById(dom.charts.wealthProjectionChart);
                    if (!chartEl) return;
                    const ctx = chartEl.getContext('2d');
                    
                    const labels = projections.map(p => `Year ${p.year}`);
                    const cashFlowData = document.getElementById(dom.toggles.wealthChartToggle)?.checked
                        ? projections.map(p => p.afterTax.cashFlow)
                        : projections.map(p => p.preTax.cashFlow);

                    const datasets = [
                        { label: 'Property Value', data: projections.map(p => p.propertyValue), backgroundColor: App.utils.hexToRgba(colors.strategy.valueadd, 0.4), borderColor: colors.strategy.valueadd, fill: 'start', yAxisID: 'yCurrency', order: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Loan Balance', data: projections.map(p => p.loanBalance), backgroundColor: App.utils.hexToRgba(colors.status.dark, 0.6), borderColor: colors.status.neutral, fill: 'start', yAxisID: 'yCurrency', order: 3, pointRadius: 0, tension: 0.1 },
                        { label: 'Annual Cash Flow', data: cashFlowData, borderColor: colors.strategy.cashflow, borderWidth: 2.5, pointRadius: 3, fill: false, tension: 0.4, yAxisID: 'yCashflow', order: 1 }
                    ];

                    if (App.charts.wealthProjection) {
                        App.charts.wealthProjection.data.labels = labels;
                        App.charts.wealthProjection.data.datasets = datasets;
                        App.charts.wealthProjection.update('none');
                    } else {
                        App.charts.wealthProjection = new Chart(ctx, {
                            type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                                scales: {
                                    x: { grid: { display: false } },
                                    yCurrency: {
                                        type: 'linear', position: 'left', title: { display: true, text: 'Value ($)' },
                                        ticks: { callback: v => formatCurrency(v) },
                                        grid: { color: '#e5e7eb' }, stacked: false
                                    },
                                    yCashflow: {
                                        type: 'linear', position: 'right', title: { display: true, text: 'Annual Cash Flow ($)' },
                                        ticks: { callback: v => formatCurrency(v,0) },
                                        grid: { drawOnChartArea: false }
                                    }
                                },
                                plugins: { datalabels: { display: false }, legend: { position: 'bottom', labels: { usePointStyle: true, boxHeight: 8 } }, tooltip: { mode: 'index', intersect: false, callbacks: { label: c => `${c.dataset.label || ''}: ${formatCurrency(c.raw)}`, footer: (items) => { const pv = items.find(i=>i.dataset.label==='Property Value'), lb = items.find(i=>i.dataset.label==='Loan Balance'); if(pv&&lb) return 'Equity: '+formatCurrency(pv.parsed.y - lb.parsed.y); return ''; } } } }
                            }
                        });
                    }
                },
                
                updateOptimalExitChart({ projections }) {
                    const { dom, colors } = App.config;
                    const { formatCurrency, formatPercent, hexToRgba } = App.utils;
                    const chartEl = document.getElementById(dom.charts.optimalExitChart);
                    if (!chartEl) return;
                    const ctx = chartEl.getContext('2d');
                    
                    const showAfterTax = document.getElementById(dom.toggles.exitChartToggle)?.checked;

                    const labels = projections.map(p => `Year ${p.year}`);
                    const datasets = [
                        { type: 'bar', label: 'Profit if Sold', data: projections.map(p => showAfterTax ? p.afterTax.profitIfSold : p.preTax.profitIfSold), backgroundColor: App.utils.hexToRgba(colors.strategy.valueadd, 0.7), borderColor: colors.strategy.valueadd, borderWidth: 1, yAxisID: 'yCurrency' },
                        { type: 'line', label: 'Annualized Return', data: projections.map(p => showAfterTax ? p.afterTax.annualizedReturn : p.preTax.annualizedReturn), borderColor: App.utils.hexToRgba(colors.strategy.appreciation, 0.9), tension: 0.2, fill: false, borderWidth: 3, pointBackgroundColor: colors.strategy.appreciation, pointRadius: 4, pointHoverRadius: 7, yAxisID: 'yPercent' },
                        { type: 'line', label: 'Return on Equity (ROE)', data: projections.map(p => showAfterTax ? p.afterTax.roe : p.preTax.roe), borderColor: colors.strategy.cashflow, tension: 0.2, fill: false, borderWidth: 2.5, borderDash: [5,5], pointBackgroundColor: colors.strategy.cashflow, pointRadius: 3, pointHoverRadius: 6, yAxisID: 'yPercent' },
                    ];
                    
                    const returns = projections.map(p => showAfterTax ? p.afterTax.annualizedReturn : p.preTax.annualizedReturn);
                    const maxReturn = Math.max(...returns.filter(isFinite));
                    let peakReturnIndex = returns.indexOf(maxReturn);
                    
                    const optimalExitPlugin = {
                        id: 'optimalExitLine',
                        afterDraw: chart => {
                            if (peakReturnIndex < 0) return;
                            const { ctx, scales, chartArea } = chart;
                            const x = scales.x.getPixelForValue(peakReturnIndex);
                            if (x < chartArea.left || x > chartArea.right) return;
                            ctx.save();
                            ctx.beginPath(); ctx.moveTo(x, chartArea.top - 10); ctx.lineTo(x, chartArea.bottom);
                            ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)'; ctx.setLineDash([6, 6]); ctx.stroke();
                            const label = `Peak Return: Year ${peakReturnIndex + 1}`;
                            ctx.font = 'bold 12px Inter, sans-serif'; ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                            ctx.textAlign = (x / chartArea.right > 0.8) ? 'right' : 'left'; ctx.textBaseline = 'middle';
                            // FIX 2: Adjust "Peak Return" label position for better visibility
                            ctx.fillText(label, x + (ctx.textAlign === 'left' ? 5 : -5) , chartArea.top - 5);
                            ctx.restore();
                        }
                    };
                    
                    if (App.charts.optimalExit) {
                        App.charts.optimalExit.data.labels = labels;
                        App.charts.optimalExit.data.datasets = datasets;
                        App.charts.optimalExit.update('none');
                    } else {
                        App.charts.optimalExit = new Chart(ctx, {
                            data: { labels, datasets }, plugins: [optimalExitPlugin], 
                            options: {
                                responsive: true, maintainAspectRatio: false, 
                                interaction: { mode: 'index', intersect: false },
                                layout: { padding: { right: 15 } },
                                scales: {
                                    yCurrency: {
                                        type: 'linear', position: 'left', title: { display: true, text: 'Total Profit ($)' },
                                        ticks: { callback: v => formatCurrency(v) }, grid: { color: '#e5e7eb' }
                                    },
                                    yPercent: {
                                        type: 'linear', position: 'right', title: { display: true, text: 'Return (%)' },
                                        ticks: { callback: v => formatPercent(v, 0) }, grid: { drawOnChartArea: false }
                                    },
                                    x: {
                                        title: { display: true, text: 'Year of Ownership' },
                                        grid: { display: false }
                                    }
                                },
                                plugins: { datalabels: { display: false }, legend: { position: 'bottom', labels: { usePointStyle: true, boxHeight: 8 } }, tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${c.dataset.yAxisID === 'yPercent' ? formatPercent(c.raw) : formatCurrency(c.raw)}` } } } 
                            }
                        });
                    }
                },

                updateAmortizationChart({ projections, state }) {
                    const { dom, colors } = App.config;
                    const { formatCurrency, hexToRgba } = App.utils;
                    const chartEl = document.getElementById(dom.charts.amortizationChart);
                    if (!chartEl) return;
                    const ctx = chartEl.getContext('2d');
                    
                    if (App.charts.amortization) App.charts.amortization.destroy();
                    
                    const labels = projections.map(p => `Year ${p.year}`);
                    const loanData = projections.map(p => p.loanBalance);

                    if (state.loanType === 'margin') {
                        const annualInterestData = projections.map(p => p.annualInterestPaid);
                        const equityData = projections.map(p => p.equity);
                        
                        App.charts.amortization = new Chart(ctx, {
                            type: 'bar', // Use bar chart as base for annual interest
                            data: { labels: labels, datasets: [
                                { // Annual Interest Paid (Bars on Y-Axis 2)
                                    type: 'bar',
                                    label: 'Annual Interest Paid',
                                    data: annualInterestData,
                                    backgroundColor: hexToRgba(colors.status.negative, 0.6),
                                    yAxisID: 'yCurrency',
                                    order: 3,
                                },
                                { // Loan Balance (Line on Y-Axis 1)
                                    type: 'line',
                                    label: 'Loan Balance',
                                    data: loanData,
                                    borderColor: colors.strategy.appreciation, 
                                    backgroundColor: hexToRgba(colors.strategy.appreciation, 0.1), 
                                    fill: false, 
                                    tension: 0.2,
                                    borderWidth: 3,
                                    yAxisID: 'yValue',
                                    order: 1,
                                    pointRadius: 4
                                },
                                { // Total Equity (Line on Y-Axis 1)
                                    type: 'line',
                                    label: 'Total Equity',
                                    data: equityData,
                                    borderColor: colors.strategy.valueadd, 
                                    backgroundColor: hexToRgba(colors.strategy.valueadd, 0.1), 
                                    fill: false, 
                                    tension: 0.2,
                                    borderWidth: 3,
                                    borderDash: [5, 5],
                                    yAxisID: 'yValue',
                                    order: 2,
                                    pointRadius: 4
                                }
                            ] },
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: false, 
                                interaction: { mode: 'index', intersect: false },
                                plugins: { 
                                    legend: { position: 'bottom' }, 
                                    datalabels: { display: false },
                                    tooltip: { 
                                        mode: 'index', 
                                        intersect: false, 
                                        callbacks: { 
                                            label: c => {
                                                if (c.dataset.type === 'bar') return `Annual Interest: ${formatCurrency(c.raw, 0)}`;
                                                return `${c.dataset.label}: ${formatCurrency(c.raw, 0)}`;
                                            }
                                        } 
                                    } 
                                }, 
                                scales: { 
                                    x: { grid: { display: false } },
                                    yValue: { 
                                        type: 'linear', position: 'left', 
                                        ticks: { callback: v => formatCurrency(v, 0) },
                                        title: { display: true, text: 'Loan Balance & Equity ($)' },
                                        grid: { color: '#e5e7eb' }, 
                                    },
                                    yCurrency: { 
                                        type: 'linear', position: 'right',
                                        ticks: { callback: v => formatCurrency(v, 0) },
                                        title: { display: true, text: 'Annual Interest Paid ($)' },
                                        grid: { drawOnChartArea: false }, 
                                        min: 0
                                    }
                                } 
                            }
                         });
                        return;
                    }

                    // Default Amortizing Loan View (Fixed/ARM)
                    const equityData = projections.map(p => p.equity);

                    App.charts.amortization = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Equity', data: equityData, borderColor: hexToRgba(colors.strategy.valueadd, 0.8), backgroundColor: hexToRgba(colors.strategy.valueadd, 0.5), fill: true, tension: 0.1, pointRadius: 0, order: 2 },
                                { label: 'Loan Balance', data: loanData, borderColor: hexToRgba(colors.status.neutral, 0.6), backgroundColor: hexToRgba(colors.status.neutral, 0.3), fill: true, tension: 0.1, pointRadius: 0, order: 1 }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'bottom' }, 
                                datalabels: { display: false }, // Explicitly disable datalabels
                                tooltip: { 
                                    mode: 'index', 
                                    intersect: false, 
                                    callbacks: { 
                                        label: c => `${c.dataset.label}: ${formatCurrency(c.raw, 0)}`, // Tooltip formats value
                                        footer: (items) => { const e = items.find(i => i.dataset.label === 'Equity')?.raw || 0, l = items.find(i => i.dataset.label === 'Loan Balance')?.raw || 0; return `Total Property Value: ${formatCurrency(e + l, 0)}`; } 
                                    } 
                                } 
                            },
                            scales: { 
                                x: { grid: { display: false } }, 
                                y: { 
                                    stacked: true, 
                                    ticks: { 
                                        callback: v => formatCurrency(v, 0) // Y-axis formats ticks
                                    }, 
                                    title: { display: true, text: 'Total Property Value ($)' } 
                                } 
                            }
                        }
                    });
                },

                updateProjectionsTable(results) {
                    const { projections, shared } = results;
                    const tableBody = document.getElementById(App.config.dom.outputs.projectionsTable);
                    if (!tableBody) return;

                    const { formatCurrency, formatPercent } = App.utils;
                    const metricColor = (val) => val >= 0 ? 'text-green-600' : 'text-red-600';
                    let breakEvenYearFound = false;

                    tableBody.innerHTML = projections.map(p => {
                        let rowClass = p.year % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                         if (shared.totalCashNeeded > 0 && p.afterTax.cumulativeCashFlow >= 0 && !breakEvenYearFound) {
                            rowClass += ' break-even-row';
                            breakEvenYearFound = true;
                        }
                        return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-3 font-medium">${p.year}</td>
                            <td class="px-4 py-3 text-right">${formatCurrency(p.propertyValue)}</td>
                            <td class="px-4 py-3 text-right text-slate-600">${formatCurrency(p.annualInterestPaid)}</td>
                            <td class="px-4 py-3 text-right text-slate-600">${formatCurrency(p.annualDepreciation)}</td>
                            <td class="px-4 py-3 text-right ${p.taxImpact > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(p.taxImpact)}</td>
                            <td class="px-4 py-3 text-right ${metricColor(p.preTax.cashFlow)}">${formatCurrency(p.preTax.cashFlow)}</td>
                            <td class="px-4 py-3 text-right font-semibold ${metricColor(p.afterTax.cashFlow)}">${formatCurrency(p.afterTax.cashFlow)}</td>
                            <td class="px-4 py-3 text-right">${formatPercent(p.afterTax.roe)}</td>
                            <td class="px-4 py-3 text-right font-semibold ${metricColor(p.afterTax.profitIfSold)}">${formatCurrency(p.afterTax.profitIfSold)}</td>
                            <td class="px-4 py-3 text-right font-bold">${formatPercent(p.afterTax.annualizedReturn)}</td>
                            <td class="px-4 py-3 text-right font-bold text-sky-700">${formatPercent(p.afterTax.realAnnualizedReturn)}</td>
                        </tr>`;
                    }).join('');
                },
            },

            events: {
                setup() {
                    this.setupTooltipSystem();
                    
                    document.querySelectorAll('input[name="investmentStrategy"]').forEach(radio => radio.addEventListener('change', (e) => this.handleInputChange(e, 'investmentStrategy')));
                    
                    const inputs = App.config.dom.inputs;
                    for (const key in inputs) {
                        if (key === 'investmentStrategy') continue;
                        const element = document.getElementById(inputs[key]);
                        if (element) {
                            element.addEventListener('input', (e) => this.handleInputChange(e, key));
                            element.addEventListener('blur', (e) => this.handleInputChange(e, key));
                        }
                    }

                    window.addEventListener('beforeunload', () => clearTimeout(App._debounceTimer));
                    this.setupCapExItemizer();
                },

                setupCapExItemizer() {
                    const toggle = document.getElementById('useItemizedCapEx');
                    const percentContainer = document.getElementById('capExPct').closest('.input-group');
                    const itemizedContainer = document.getElementById('itemizedCapExContainer');
                    const addBtn = document.getElementById('addCapExItemBtn');
                    const listContainer = document.getElementById('itemizedCapExList');

                    const updateVisibility = () => {
                        if (toggle.checked) {
                            percentContainer.classList.add('hidden');
                            itemizedContainer.classList.remove('hidden');
                        } else {
                            percentContainer.classList.remove('hidden');
                            itemizedContainer.classList.add('hidden');
                        }
                    };

                    const createItemRow = (item = { desc: '', cost: '', year: '' }) => {
                        const row = document.createElement('div');
                        row.className = 'grid grid-cols-[1fr_100px_60px_auto] gap-2 items-center';
                        row.innerHTML = `
                            <input type="text" placeholder="Description (e.g., Roof)" class="capex-desc w-full rounded-md shadow-sm sm:text-sm border-slate-300 bg-slate-50 focus:bg-white focus:border-slate-400" value="${item.desc || ''}">
                            <input type="text" placeholder="Cost ($)" class="capex-cost w-full rounded-md shadow-sm sm:text-sm border-slate-300 bg-slate-50 focus:bg-white focus:border-slate-400" value="${item.cost || ''}">
                            <input type="text" placeholder="Year" class="capex-year w-full rounded-md shadow-sm sm:text-sm border-slate-300 bg-slate-50 focus:bg-white focus:border-slate-400" value="${item.year || ''}">
                            <button type="button" class="remove-capex-btn text-red-500 hover:text-red-700 font-bold text-xl h-full flex items-center justify-center">×</button>
                        `;
                        listContainer.appendChild(row);
                        row.querySelector('.remove-capex-btn').addEventListener('click', () => {
                            row.remove();
                            App.runAnalysis();
                        });
                        row.querySelectorAll('input').forEach(input => {
                            input.addEventListener('input', () => {
                                clearTimeout(App._debounceTimer);
                                App._debounceTimer = setTimeout(() => App.runAnalysis(), 250);
                            });
                            input.addEventListener('blur', (e) => {
                                if (e.target.classList.contains('capex-cost')) {
                                    e.target.value = App.utils.formatNumber(e.target.value);
                                }
                                // The 'year' field is intentionally not formatted with commas.
                                // // Rerun analysis on blur from any itemized field to ensure state is current.
                                App.runAnalysis();
                            });
                        });
                    };

                    toggle.addEventListener('change', () => {
                        updateVisibility();
                        App.runAnalysis();
                    });

                    addBtn.addEventListener('click', () => createItemRow());
                    
                    App.renderItemizedCapEx = (items = []) => {
                        listContainer.innerHTML = '';
                        if (items.length > 0) {
                            items.forEach(createItemRow);
                        } else if (toggle.checked) {
                            createItemRow();
                        }
                        updateVisibility();
                    };
                    updateVisibility();
                },
                
                setupTooltipSystem() {
                    App.ui._tooltipEl = document.getElementById('global-tooltip');
                    
                    document.body.addEventListener('mouseover', e => {
                        const container = e.target.closest('.tooltip-container[data-tooltip]');
                        if (container && App.ui._tooltipEl) {
                        App.ui._tooltipEl.innerHTML = container.dataset.tooltip;
                        App.ui._tooltipEl.classList.add('visible');
                        this.positionTooltip(container);
                        }
                    });
                    document.body.addEventListener('mouseout', e => {
                        const container = e.target.closest('.tooltip-container[data-tooltip]');
                        if (container && App.ui._tooltipEl) {
                        App.ui._tooltipEl.classList.remove('visible');
                        }
                    });
                },

                positionTooltip(container) {
                    const tooltipEl = App.ui._tooltipEl;
                    if (!tooltipEl) return;
                    const iconRect = container.getBoundingClientRect();
                    
                    let top = iconRect.top - tooltipEl.offsetHeight - 8;
                    let left = iconRect.left + (iconRect.width / 2) - (tooltipEl.offsetWidth / 2);
                    
                    if(top < 0) top = iconRect.bottom + 8;
                    if(left < 0) left = 5;
                    if(left + tooltipEl.offsetWidth > window.innerWidth) left = window.innerWidth - tooltipEl.offsetWidth - 5;

                    tooltipEl.style.top = `${top}px`;
                    tooltipEl.style.left = `${left}px`;
                },

                setupOutputListeners() {
                    const wealthToggle = document.getElementById(App.config.dom.toggles.wealthChartToggle);
                    if (wealthToggle) wealthToggle.addEventListener('change', () => App.ui.updateWealthProjectionChart(App.lastResults));

                    const breakdownToggle = document.getElementById(App.config.dom.toggles.breakdownToggle);
                    if (breakdownToggle) breakdownToggle.addEventListener('change', () => App.ui.updateBreakdownChart(App.lastResults));

                    const exitToggle = document.getElementById(App.config.dom.toggles.exitChartToggle);
                    if (exitToggle) exitToggle.addEventListener('change', () => App.ui.updateOptimalExitChart(App.lastResults));
                    
                    const timeToggle = document.getElementById(App.config.dom.toggles.timeHorizonToggle);
                    if (timeToggle) timeToggle.addEventListener('change', () => App.ui.updateKeyMetrics(App.lastResults));
                    
                    const taxToggle = document.getElementById(App.config.dom.toggles.taxStatusToggle);
                    if (taxToggle) taxToggle.addEventListener('change', () => App.ui.updateKeyMetrics(App.lastResults));
                    
                    // NEW: Projections Chart Toggles and Listeners
                    const projectionsToggle = document.getElementById(App.config.dom.outputs.projectionsChartToggle);
                    const projectionsSelector = document.getElementById(App.config.dom.outputs.projectionsDataSelector);

                    const toggleProjectionView = () => {
                        const isChart = projectionsToggle.checked;
                        document.getElementById('projectionsTableWrapper').classList.toggle('hidden', isChart);
                        document.getElementById('analysisChartContainer').classList.toggle('hidden', !isChart);
                        if (isChart) {
                            App.ui.renderProjectionsDataSelector();
                            App.ui.updateProjectionsChart(App.lastResults);
                        } else {
                            if (App.charts.projections) App.charts.projections.destroy();
                        }
                    };

                    if (projectionsToggle) projectionsToggle.addEventListener('change', toggleProjectionView);
                    if (projectionsSelector) projectionsSelector.addEventListener('change', () => App.ui.updateProjectionsChart(App.lastResults));
               },
                
                handleInputChange(e, key) {
                    if (key === 'investmentStrategy') this.updateCriteriaForStrategy(e.target.value);
                    if (key === 'loanType') this.toggleLoanInputs(e.target.value);
                    this.validate(e.target, key);
                    if (e.type === 'blur' && e.target.value && e.target.type !== 'select-one' && !e.target.classList.contains('capex-desc')) {
                        e.target.value = App.utils.formatNumber(e.target.value);
                    }
                    clearTimeout(App._debounceTimer);
                    App._debounceTimer = setTimeout(() => App.runAnalysis(), 250);
                },
                updateCriteriaForStrategy(strategy) {
                    const presets = App.config.strategyPresets[strategy];
                    if (!presets) return;
                    for (const key in presets) {
                        const element = document.getElementById(App.config.dom.inputs[key]);
                        if (element) {
                            element.value = App.utils.formatNumber(presets[key]);
                            this.validate(element, key);
                        }
                    }
                },
                toggleLoanInputs(loanType) {
                    const { dom } = App.config;
                    const fixedRateGroup = document.getElementById(dom.groups.fixedRateGroup);
                    const armRateGroup = document.getElementById(dom.groups.armRateGroup);
                    const marginLoanGroup = document.getElementById(dom.groups.marginLoanGroup);
                    const loanTermInput = document.getElementById(dom.inputs.loanTerm);

                    if(fixedRateGroup) fixedRateGroup.classList.toggle('hidden', !loanType.startsWith('fixed'));
                    if(armRateGroup) armRateGroup.classList.toggle('hidden', !loanType.startsWith('arm'));
                    if(marginLoanGroup) marginLoanGroup.classList.toggle('hidden', loanType !== 'margin');
                    
                    if (loanTermInput) {
                        if (loanType === 'fixed15') loanTermInput.value = 15;
                        else if (loanType === 'margin') loanTermInput.value = document.getElementById(dom.inputs.holdPeriod).value; // Loan Term defaults to Hold Period for Margin
                        else loanTermInput.value = 30;
                    }
                },
                validate(element, key) {
                    const rules = App.config.validationRules[key];
                    if (!rules) return true;
                    const value = App.utils.parseNumber(element.value);
                    const inputGroup = element.closest('.input-group');
                    if (!inputGroup) return true;
                    const errorContainer = inputGroup.querySelector('.validation-error');
                    const errorEl = errorContainer ? errorContainer.querySelector('span') : null;
                    if (!errorEl) return true;

                    let isValid = true; let message = '';

                    if (rules.required && element.value.trim() === '') { isValid = false; message = 'This field is required.'; }
                    else if (rules.isPositive && value <= 0) { isValid = false; message = rules.message; }
                    else if (rules.isNonNegative && value < 0) { isValid = false; message = rules.message; }
                    else if (rules.min !== undefined && value < rules.min) { isValid = false; message = rules.message; }
                    else if (rules.max !== undefined && value > rules.max) { isValid = false; message = rules.message; }
                    
                    inputGroup.classList.toggle('invalid', !isValid);
                    errorEl.textContent = message;
                    return isValid;
                },
            },

            runAnalysis() {
                this.state = {};
                let isAllValid = true;
                for (const key in this.config.dom.inputs) {
                    if (key === 'investmentStrategy') {
                        const checkedRadio = document.querySelector('input[name="investmentStrategy"]:checked');
                        this.state[key] = checkedRadio ? checkedRadio.value : this.config.defaults[key];
                        continue;
                    }
                    if (key === 'itemizedCapEx') {
                        const items = [];
                        document.querySelectorAll('#itemizedCapExList .grid').forEach(row => {
                            const desc = row.querySelector('.capex-desc').value;
                            const cost = App.utils.parseNumber(row.querySelector('.capex-cost').value);
                            const year = App.utils.parseNumber(row.querySelector('.capex-year').value);
                            if (cost > 0 && year > 0) {
                                items.push({ desc, cost, year });
                            }
                        });
                        this.state[key] = items;
                        continue;
                    }
                    
                    const element = document.getElementById(this.config.dom.inputs[key]);
                    if (element) {
                        if (element.type === 'checkbox') {
                            this.state[key] = element.checked;
                        } else {
                            if (!this.events.validate(element, key)) isAllValid = false;
                            this.state[key] = (element.tagName.toLowerCase() === 'select') ? this.utils.parseString(element.value) : App.utils.parseNumber(element.value);
                        }
                    }
                }

                if (!isAllValid) return;

                const currentStateJSON = JSON.stringify(this.state);
                if (currentStateJSON === this._lastStateJSON) return;
                this._lastStateJSON = currentStateJSON;

                const results = this.calculator.run(this.state);
                results.state = this.state;
                this.lastResults = results;

                this.ui.update(results);
                this.url.update(this.state);
            },

            init() {
                const domReady = () => {
                    window.App = this;
                
                    Chart.register(ChartDataLabels);
                    ScenarioManager.init();
                
                    // 1. Setup events first to ensure all functions, like renderItemizedCapEx, are defined.
                    this.events.setup();
                
                    // 2. Set defaults and then apply the saved state from the URL.
                    this.ui.setInputsToDefault();
                    const loadedState = this.url.load();
                    if (loadedState) {
                        this.ui.applyState(loadedState);
                    }
                
                    // 3. Format any initial numbers.
                    Object.keys(this.config.dom.inputs).forEach(key => {
                        const el = document.getElementById(this.config.dom.inputs[key]);
                        if (el && el.type !== 'select-one' && el.value && !el.classList.contains('capex-desc')) {
                            el.value = App.utils.formatNumber(el.value);
                        }
                    });
                
                    // 4. Run the initial analysis.
                    this.runAnalysis();
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', domReady);
                } else {
                    domReady();
                }
            }
        };

        const ScenarioManager = {
            STORAGE_KEY: 'realEstateScenarios_v3',
            init() {
                document.getElementById('manageScenariosBtn').addEventListener('click', () => this.showModal());
                document.getElementById('closeScenarioModal').addEventListener('click', () => this.hideModal());
                document.getElementById('showSaveFormBtn').addEventListener('click', () => this.showSaveForm());
                document.getElementById('cancelSaveScenarioBtn').addEventListener('click', () => this.hideSaveForm());
                document.getElementById('confirmSaveScenarioBtn').addEventListener('click', () => this.saveCurrent());
                document.getElementById('importScenariosBtn').addEventListener('click', () => this.importFromCsv());
                document.getElementById('exportScenariosCsvBtn').addEventListener('click', () => this.exportToCsv());
                document.getElementById('exportSelectedXlsxBtn').addEventListener('click', () => this.exportToXlsx());
            },
            
            showSaveForm() {
                document.getElementById('showSaveFormBtn').classList.add('hidden');
                document.getElementById('saveScenarioForm').classList.remove('hidden');
                const nameInput = document.getElementById('scenarioNameInput');
                nameInput.value = `Analysis for ${App.utils.formatCurrency(App.state.purchasePrice)} property`;
                nameInput.focus();
            },

            hideSaveForm() {
                document.getElementById('saveScenarioForm').classList.add('hidden');
                document.getElementById('showSaveFormBtn').classList.remove('hidden');
            },

            saveCurrent() {
                const nameInput = document.getElementById('scenarioNameInput');
                const name = nameInput.value.trim();
                if (!name) {
                    nameInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    return;
                }
                nameInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');

                const scenario = {
                    id: `scenario_${new Date().getTime()}`,
                    timestamp: new Date().toISOString(),
                    name: name,
                    data: JSON.parse(JSON.stringify(App.state)) // Deep copy
                };

                const scenarios = this.getAll();
                scenarios.push(scenario);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(scenarios));
                this.renderModalContent();
                this.hideSaveForm();
            },
            
            load(scenarioId) {
                const scenario = this.getAll().find(s => s.id === scenarioId);
                if (scenario && scenario.data) {
                    App.ui.applyState(scenario.data);
                    App.runAnalysis();
                    App.renderItemizedCapEx(scenario.data.itemizedCapEx);
                    this.hideModal();
                }
            },
            
            delete(scenarioId) {
                if (confirm('Are you sure you want to delete this scenario?')) {
                    let scenarios = this.getAll();
                    scenarios = scenarios.filter(s => s.id !== scenarioId);
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(scenarios));
                    this.renderModalContent();
                }
            },

            getAll() {
                try {
                    return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
                } catch(e) {
                    console.error("Error parsing scenarios from localStorage", e);
                    return [];
                }
            },

            showModal() {
                this.renderModalContent();
                document.getElementById('scenarioModal').classList.remove('hidden');
            },

            hideModal() {
                document.getElementById('scenarioModal').classList.add('hidden');
            },
            
            renderModalContent() {
                const listEl = document.getElementById('scenarioList');
                const scenarios = this.getAll().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const exportBtn = document.getElementById('exportSelectedXlsxBtn');

                const updateExportButtonState = () => {
                    const checkedCount = listEl.querySelectorAll('input[type="checkbox"]:checked').length;
                    if(exportBtn) {
                        exportBtn.disabled = checkedCount === 0;
                        exportBtn.textContent = `Export Selected (${checkedCount}) to XLSX`;
                    }
                };

                let scenariosHTML = `
                <div class="border rounded-lg p-4 flex justify-between items-center bg-blue-50 border-blue-200">
                    <label class="flex items-center gap-3 cursor-pointer w-full">
                        <input type="checkbox" data-id="current" class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500" checked>
                        <div>
                            <p class="font-semibold text-slate-800">(Current Unsaved Analysis)</p>
                            <div class="text-xs text-slate-500 mt-1">The inputs currently on your screen.</div>
                        </div>
                    </label>
                </div>`;
                
                if (scenarios.length === 0) {
                    listEl.innerHTML = scenariosHTML + '<p class="text-center text-slate-500 py-4">No saved scenarios yet.</p>';
                } else {
                    scenariosHTML += scenarios.map(s => `
                    <div class="border border-slate-200 rounded-lg p-4 flex justify-between items-start gap-3">
                        <label class="flex items-center gap-3 cursor-pointer flex-grow">
                            <input type="checkbox" data-id="${s.id}" class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <div class="flex-grow">
                                <p class="font-semibold text-slate-800">${s.name}</p>
                                <div class="text-xs text-slate-500 mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                    <span>${new Date(s.timestamp).toLocaleDateString()}</span>
                                    <span><strong>Price:</strong> ${App.utils.formatCurrency(s.data.purchasePrice)}</span>
                                </div>
                            </div>
                        </label>
                        <div class="space-x-2 flex-shrink-0">
                            <button class="load-scenario-btn bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs font-bold py-1 px-3 rounded-full transition-colors" data-id="${s.id}">Load</button>
                            <button class="delete-scenario-btn bg-red-100 text-red-700 hover:bg-red-200 text-xs font-bold py-1 px-3 rounded-full transition-colors" data-id="${s.id}">Delete</button>
                        </div>
                    </div>
                `).join('');
                listEl.innerHTML = scenariosHTML;
                }
                
                listEl.querySelectorAll('.load-scenario-btn').forEach(btn => btn.addEventListener('click', e => this.load(e.target.dataset.id)));
                listEl.querySelectorAll('.delete-scenario-btn').forEach(btn => btn.addEventListener('click', e => this.delete(e.target.dataset.id)));
                listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', updateExportButtonState));
                updateExportButtonState();
            },
            
            exportToCsv() {
                const scenarios = this.getAll();
                if (scenarios.length === 0) {
                    const exportBtn = document.getElementById('exportScenariosCsvBtn');
                    exportBtn.textContent = 'Nothing to Export';
                    setTimeout(() => { exportBtn.textContent = 'Export Snapshot (CSV)'; }, 2000);
                    return;
                }

                const headers = ['scenario_id', 'scenario_name', 'scenario_timestamp', ...Object.keys(App.config.dom.inputs)];
                const csvRows = scenarios.map(s => {
                    const row = [s.id, s.name, s.timestamp];
                    Object.keys(App.config.dom.inputs).forEach(key => {
                        const value = s.data && s.data[key] !== undefined ? s.data[key] : '';
                        if (typeof value === 'object') {
                             row.push(JSON.stringify(value));
                        } else {
                            row.push(value);
                        }
                    });
                    return row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
                });

                const csvString = [headers.join(','), ...csvRows].join('\r\n');
                const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvString);
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "real_estate_scenarios_snapshot.csv");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            importFromCsv() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv';
                fileInput.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const importBtn = document.getElementById('importScenariosBtn');
                        try {
                            const csv = event.target.result;
                            const lines = csv.split(/\r\n|\n/).filter(line => line.trim() !== '');
                            if(lines.length < 2) throw new Error("CSV has no data rows.");
                            
                            const parseCsvLine = line => line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
                            const headers = parseCsvLine(lines[0]);
                            const newScenarios = [];

                            for(let i = 1; i < lines.length; i++) {
                                const values = parseCsvLine(lines[i]);
                                if (values.length !== headers.length) {
                                    console.warn(`Skipping malformed CSV row ${i + 1}`);
                                    continue;
                                }
                                const rowData = headers.reduce((obj, header, index) => {
                                    obj[header] = values[index];
                                    return obj;
                                }, {});

                                const importedData = {};
                                Object.keys(App.config.defaults).forEach(key => {
                                    const value = rowData[key];
                                    if(value !== undefined && value !== '') {
                                        if (['investmentStrategy', 'loanType', 'depreciationMethod'].includes(key)) {
                                            importedData[key] = App.utils.parseString(value);
                                        } else if(key === 'useItemizedCapEx') {
                                            importedData[key] = value.toLowerCase() === 'true';
                                        } else if(key === 'itemizedCapEx') {
                                            try { importedData[key] = JSON.parse(value || '[]'); } catch { importedData[key] = []; }
                                        } else {
                                            importedData[key] = App.utils.parseNumber(value);
                                        }
                                    } else {
                                        importedData[key] = App.config.defaults[key];
                                    }
                                });

                                newScenarios.push({
                                    id: rowData.scenario_id || `scenario_${new Date().getTime() + i}`,
                                    name: rowData.scenario_name || `Imported Scenario ${i}`,
                                    timestamp: rowData.scenario_timestamp || new Date().toISOString(),
                                    data: importedData,
                                });
                            }
                            
                            const existingScenarios = this.getAll();
                            const combined = [...existingScenarios, ...newScenarios];
                            const uniqueScenarios = Array.from(new Map(combined.map(item => [item.id, item])).values());
                            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(uniqueScenarios));
                            
                            importBtn.textContent = `✓ Imported ${newScenarios.length}!`;
                            setTimeout(() => { importBtn.textContent = 'Import Snapshot (CSV)'; }, 2500);
                            this.renderModalContent();

                        } catch (error) {
                            console.error("Error during CSV import:", error);
                            importBtn.textContent = 'Import Failed!';
                            importBtn.classList.add('text-red-600');
                            setTimeout(() => { 
                                importBtn.textContent = 'Import Snapshot (CSV)'; 
                                importBtn.classList.remove('text-red-600');
                            }, 3000);
                        }
                    };
                    reader.readAsText(file);
                };
                fileInput.click();
            },
            
            exportToXlsx() {
                const listEl = document.getElementById('scenarioList');
                const checkedBoxes = listEl.querySelectorAll('input[type="checkbox"]:checked');
                const exportBtn = document.getElementById('exportSelectedXlsxBtn');
                
                if (checkedBoxes.length === 0) return;
                
                const originalText = exportBtn.textContent;
                exportBtn.textContent = 'Generating...';
                exportBtn.disabled = true;

                setTimeout(() => { // Use timeout to allow UI to update
                    const scenariosToExport = [];
                    const allSavedScenarios = this.getAll();

                    checkedBoxes.forEach(cb => {
                        const id = cb.dataset.id;
                        if (id === 'current') {
                            scenariosToExport.push({
                                name: 'Current Analysis',
                                data: App.state
                            });
                        } else {
                            const saved = allSavedScenarios.find(s => s.id === id);
                            if(saved) scenariosToExport.push(saved);
                        }
                    });
                    
                    XlsxExporter.generate(scenariosToExport);
                    
                    exportBtn.textContent = '✓ Exported!';
                    setTimeout(() => { 
                        exportBtn.textContent = originalText;
                        this.renderModalContent(); // To re-enable the button correctly
                    }, 2500);

                }, 50); // Small delay
            }
        };

        const XlsxStyler = {
            styles: {
                header1: { font: { bold: true, sz: 16 }, fill: { fgColor: { rgb: "DDEBF7" } }, alignment: { vertical: "center", horizontal: "center" } },
                header2: { font: { bold: true, sz: 13 }, fill: { fgColor: { rgb: "F2F2F2" } } },
                bold: { font: { bold: true } },
                right: { alignment: { horizontal: "right" } },
                currency: { numFmt: "$#,##0", alignment: { horizontal: "right" } },
                currencyCents: { numFmt: "$#,##0.00", alignment: { horizontal: "right" } },
                percent: { numFmt: "0.00%", alignment: { horizontal: "right" } },
                number: { numFmt: "#,##0", alignment: { horizontal: "right" } },
                number2dec: { numFmt: "0.00", alignment: { horizontal: "right" } },
                redFont: { font: { color: { rgb: "9C0006" } } },
            },
            merge(...styleKeys) {
                return styleKeys.reduce((acc, key) => ({ ...acc, ...this.styles[key] }), {});
            },
            cell(value, styleKeys = [], type = 's') {
                const s = this.merge(...styleKeys);
                if (typeof value === 'number') {
                    return { t: 'n', v: value, s };
                }
                return { v: String(value), s };
            }
        };

        const XlsxExporter = {
            generate(scenarios) {
                const wb = XLSX.utils.book_new();

                scenarios.forEach(scenario => {
                    const results = App.calculator.run(scenario.data);
                    const sanitizedName = scenario.name.replace(/[\\/*?\[\]]/g, '').substring(0, 31);
                    
                    const { sheetData, merges, columnWidths } = this._buildWorksheetData(scenario, results);
                    
                    const ws = {};
                    let maxCols = 0;
                    sheetData.forEach((rData, r) => {
                        if (rData.length > maxCols) maxCols = rData.length;
                        rData.forEach((cell, c) => {
                            if (cell === null || cell === undefined) return;
                            const cellRef = XLSX.utils.encode_cell({ r, c });
                            ws[cellRef] = cell;
                        });
                    });
                    
                    const range = { s: { c: 0, r: 0 }, e: { c: maxCols - 1, r: sheetData.length - 1 } };
                    ws['!ref'] = XLSX.utils.encode_range(range);

                    ws['!merges'] = merges;
                    ws['!cols'] = columnWidths;
                    ws['!freeze'] = { xSplit: "1", ySplit: "3", topLeftCell: "B4", activePane: "bottomRight" };

                    XLSX.utils.book_append_sheet(wb, ws, sanitizedName);
                });
                
                const today = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `PropertyLens_Analysis_${today}.xlsx`);
            },

            _buildWorksheetData(scenario, results) {
                const { state, shared, projections } = results;
                const finalYear = projections.length > 0 ? projections[projections.length - 1] : {};
                const S = XlsxStyler;
                let data = [], merges = [], row = 0;

                const addRow = (rowData) => { data.push(rowData); row++; };
                const skipRow = (count = 1) => { for(let i=0; i<count; i++) { data.push([]); row++; }};
                
                // --- SECTION 1: TITLE & EXECUTIVE SUMMARY ---
                merges.push({ s: { r: row, c: 0 }, e: { r: row, c: 8 } });
                addRow([S.cell(`Analysis Report: ${scenario.name}`, ['header1'])]);
                skipRow();
                merges.push({ s: { r: row, c: 0 }, e: { r: row, c: 8 } });
                addRow([S.cell('Executive Summary: Investment Showdown', ['header2'])]);

                const sp500Results = App.calculator.calculateSp500EquivalentReturn(state.holdPeriod, shared.totalCashNeeded, state.capitalGainsTaxRate, state.sp500Return);
                const totalDepreciation = (finalYear.year || 0) * (state.purchasePrice * (1 - state.landValuePct / 100) / 27.5);
                const saleProceeds = (finalYear.propertyValue || 0) - ((finalYear.propertyValue || 0) * state.salesExpensesPct / 100) - (finalYear.loanBalance || 0);
                const capitalGain = (finalYear.propertyValue || 0) - ((finalYear.propertyValue || 0) * state.salesExpensesPct / 100) - state.purchasePrice;
                const depreciationRecapture = Math.min(Math.max(0, capitalGain), totalDepreciation);
                const appreciationGain = capitalGain - depreciationRecapture;
                const taxOnSale = (depreciationRecapture * state.marginalTaxRate/100) + (appreciationGain > 0 ? appreciationGain * state.capitalGainsTaxRate/100 : 0);
                const finalCashflow = (projections[projections.length-1]?.afterTax.cashFlow || 0) + saleProceeds - taxOnSale;
                const propertyCashFlows = [-shared.totalCashNeeded, ...projections.slice(0, -1).map(p => p.afterTax.cashFlow), finalCashflow];
                const propertyIRR = App.calculator.calculateIRR(propertyCashFlows) || 0;
                const sp500CashFlows = [-shared.totalCashNeeded, ...Array(state.holdPeriod - 1).fill(0), sp500Results.finalValue];
                const sp500IRR = App.calculator.calculateIRR(sp500CashFlows) || 0;

                addRow([S.cell('Metric', ['bold']), S.cell('This Property', ['bold', 'right']), S.cell('S&P 500', ['bold', 'right'])]);
                addRow([S.cell('IRR (Internal Rate of Return)'), S.cell(propertyIRR, ['percent']), S.cell(sp500IRR, ['percent'])]);
                addRow([S.cell('Total After-Tax Profit'), S.cell(finalYear.afterTax?.profitIfSold || 0, ['currency']), S.cell(sp500Results.totalProfit, ['currency'])]);
                addRow([S.cell('MoIC (Multiple on Invested Capital)'), S.cell(App.calculator.calculateMoIC(propertyCashFlows), ['number2dec']), S.cell(App.calculator.calculateMoIC(sp500CashFlows), ['number2dec'])]);
                skipRow(2);

                // --- SECTION 2: ASSUMPTIONS & DETAILED SALE ANALYSIS ---
                merges.push({ s: { r: row, c: 0 }, e: { r: row, c: 3 } });
                merges.push({ s: { r: row, c: 5 }, e: { r: row, c: 8 } });
                addRow([S.cell('Inputs & Assumptions', ['header2']), , , , , S.cell(`Sale Analysis (End of Year ${state.holdPeriod})`, ['header2'])]);

                const inputs = [
                    ['Purchase Price', S.cell(state.purchasePrice, ['currency'])], ['Down Payment', S.cell(state.downPayment / 100, ['percent'])],
                    ['Rehab Costs', S.cell(state.rehabCosts, ['currency'])], ['Interest Rate', S.cell(state.interestRate / 100, ['percent'])],
                    ['Closing Costs', S.cell(state.closingCosts, ['currency'])], ['Loan Term', S.cell(state.loanTerm, ['number'])],
                    ['Gross Monthly Rent', S.cell(state.grossMonthlyRent, ['currency'])], ['Value Growth %', S.cell(state.annualValueGrowth / 100, ['percent'])],
                    ['Vacancy %', S.cell(state.vacancyPct / 100, ['percent'])], ['Income Growth %', S.cell(state.annualIncomeGrowth / 100, ['percent'])],
                    ['Repairs %', S.cell(state.maintenancePct / 100, ['percent'])], ['Expense Growth %', S.cell(state.annualExpenseGrowth / 100, ['percent'])],
                    ['Marginal Tax Rate %', S.cell(state.marginalTaxRate / 100, ['percent'])], ['Selling Costs %', S.cell(state.salesExpensesPct / 100, ['percent'])],
                    ['Capital Gains Rate %', S.cell(state.capitalGainsTaxRate / 100, ['percent'])], ['Land Value %', S.cell(state.landValuePct / 100, ['percent'])],
                ];

                const saleAnalysis = [
                    ['Future Sale Price', S.cell(finalYear.propertyValue || 0, ['currency'])],
                    ['Less: Selling Costs', S.cell(-((finalYear.propertyValue || 0) * state.salesExpensesPct / 100), ['currency', 'redFont'])],
                    ['Less: Loan Payoff', S.cell(-(finalYear.loanBalance || 0), ['currency', 'redFont'])],
                    ['Less: Tax on Sale', S.cell(-taxOnSale, ['currency', 'redFont'])],
                    ['  Depreciation Recapture Tax', S.cell(-(depreciationRecapture * state.marginalTaxRate/100), ['currency', 'redFont'])],
                    ['  Capital Gains Tax', S.cell(-(appreciationGain > 0 ? appreciationGain * state.capitalGainsTaxRate/100 : 0), ['currency', 'redFont'])],
                    [],
                    ['Net Cash From Sale', S.cell(saleProceeds - taxOnSale, ['currency', 'bold'])],
                    ['+ Cumulative After-Tax CF', S.cell(finalYear.afterTax?.cumulativeCashFlow || 0, ['currency'])],
                    ['- Total Capital Invested', S.cell(-shared.totalCashNeeded, ['currency', 'redFont'])],
                    [],
                    ['Total Net Profit', S.cell(finalYear.afterTax?.profitIfSold || 0, ['currency', 'bold'])],
                ];

                for (let i = 0; i < Math.max(Math.ceil(inputs.length / 2), saleAnalysis.length); i++) {
                    const i1 = i * 2;
                    const i2 = i1 + 1;
                    const saleRow = saleAnalysis[i] || [];
                    addRow([
                        S.cell(inputs[i1]?.[0]), inputs[i1]?.[1], S.cell(inputs[i2]?.[0]), inputs[i2]?.[1],
                        , // Spacer column
                        S.cell(saleRow[0]), , S.cell(saleRow[1])
                    ]);
                    merges.push({ s: { r: row - 1, c: 6 }, e: { r: row - 1, c: 7 } });
                }
                skipRow(2);
                
                // --- SECTION 3: ANNUAL PROJECTIONS ---
                merges.push({ s: { r: row, c: 0 }, e: { r: row, c: 12 } });
                addRow([S.cell('Annual Projections', ['header2'])]);
                const projHeaders = ['Year', 'Value', 'Equity', 'Loan Balance', 'NOI', 'Pre-Tax CF', 'Depreciation', 'Tax Impact', 'After-Tax CF', 'Cumulative CF', 'ROE', 'Total ROI (Ann.)'];
                addRow(projHeaders.map(h => S.cell(h, ['bold', 'right'])));
                projections.forEach(p => {
                    const isNegativeCF = p.afterTax.cashFlow < 0;
                    addRow([
                        S.cell(p.year, ['number']), S.cell(p.propertyValue, ['currency']), S.cell(p.equity, ['currency']), S.cell(p.loanBalance, ['currency']),
                        S.cell(p.annualNOI, ['currency']), S.cell(p.preTax.cashFlow, ['currency']), S.cell(p.annualDepreciation, ['currency']), S.cell(p.taxImpact, p.taxImpact > 0 ? ['currency', 'redFont'] : ['currency']),
                        S.cell(p.afterTax.cashFlow, isNegativeCF ? ['currency', 'bold', 'redFont'] : ['currency', 'bold']), S.cell(p.afterTax.cumulativeCashFlow, ['currency']),
                        S.cell(p.afterTax.roe, ['percent']), S.cell(p.afterTax.annualizedReturn, ['percent', 'bold'])
                    ]);
                });
                skipRow(2);

                // --- SECTION 4: DETAILED MONTHLY CASH FLOW ---
                const monthlyProjections = App.calculator.calculateMonthlyProjections(state, results);
                const maxMonthsToShow = Math.min(360, state.holdPeriod * 12);
                merges.push({ s: { r: row, c: 0 }, e: { r: row, c: maxMonthsToShow + 1 } });
                addRow([S.cell('Detailed Monthly Cash Flow (Hold Period)', ['header2'])]);
                
                const monthlyHeaders = ["Metric"];
                for (let i = 1; i <= maxMonthsToShow; i++) { monthlyHeaders.push(`M${i}`); }
                data.push(monthlyHeaders.map(h => S.cell(h, ['bold', 'right']))); row++;
                
                const metricRows = [
                    "INCOME",
                    { label: "Gross Scheduled Rent", key: "grossScheduledRent", style: ["currency"] },
                    { label: "Other Income", key: "otherIncome", style: ["currency"] },
                    { label: "Less: Vacancy Loss", key: "vacancyLoss", style: ["currency", "redFont"] },
                    { label: "Effective Gross Income", key: "effectiveGrossIncome", style: ["currency", "bold"] },
                    "OPERATING EXPENSES",
                    { label: "Property Taxes", key: "propTaxes", style: ["currency"] },
                    { label: "Insurance", key: "insurance", style: ["currency"] },
                    { label: "Repairs & Maintenance", key: "repairs", style: ["currency"] },
                    { label: "Property Management", key: "management", style: ["currency"] },
                    { label: "HOA Fees", key: "hoa", style: ["currency"] },
                    { label: "Other Expenses", key: "otherFixedExpenses", style: ["currency"] },
                    { label: "Total Operating Expenses", key: "totalOpEx", style: ["currency", "bold", "redFont"] },
                    "PROFITABILITY & DEBT",
                    { label: "Net Operating Income (NOI)", key: "noi", style: ["currency", "bold"] },
                    { label: "Less: Debt Service (P&I)", key: "debtService", style: ["currency", "redFont"] },
                    { label: "Less: Capital Expenditures", key: "capEx", style: ["currency", "redFont"] },
                    { label: "Cash Flow Before Tax", key: "cashFlowBeforeTax", style: ["currency", "bold"] },
                    "AFTER-TAX ANALYSIS",
                    { label: "Less: Tax Impact / (Shield)", key: "taxImpact", style: ["currency", "redFont"] },
                    { label: "Cash Flow After Tax", key: "cashFlowAfterTax", style: ["currency", "bold"] },
                    "BALANCE SHEET",
                    { label: "Property Value", key: "propertyValue", style: ["currency"] },
                    { label: "Ending Loan Balance", key: "endingLoanBalance", style: ["currency"] },
                    { label: "Total Equity", key: "totalEquity", style: ["currency", "bold"] },
                    "KPIS & CUMULATIVE",
                    { label: "Cumulative After-Tax CF", key: "cumulativeAfterTaxCF", style: ["currency", "bold"] },
                    { label: "Debt Service Coverage Ratio (DSCR)", key: "dscr", style: ["number2dec"] },
                    { label: "Return on Equity (ROE %)", key: "roe", style: ["percent"] },
                ];

                metricRows.forEach(metric => {
                    if (typeof metric === 'string') {
                        const headerRow = [S.cell(metric, ['bold'])];
                        merges.push({ s: { r: row, c: 0 }, e: { r: row, c: maxMonthsToShow + 1 } });
                        data.push(headerRow); row++;
                        return;
                    }
                    
                    const rowData = [S.cell(`  ${metric.label}`)];
                    for (let i = 0; i < maxMonthsToShow; i++) {
                        const val = monthlyProjections[i][metric.key];
                        if (!isFinite(val)) {
                            rowData.push(S.cell('N/A', ['right']));
                            continue;
                        }
                        const isNegative = val < 0;
                        let finalStyle = metric.style;
                        if (isNegative && (metric.style.includes('currency') || metric.style.includes('currencyCents'))) {
                            finalStyle = [...metric.style, 'redFont'];
                        }
                        rowData.push(S.cell(val, finalStyle));
                    }
                    data.push(rowData); row++;
                });
                skipRow(2);

                // --- SECTION 5: LOAN AMORTIZATION SCHEDULE ---
                merges.push({ s: { r: row, c: 0 }, e: { r: row, c: 4 } });
                addRow([S.cell('Loan Amortization Schedule', ['header2'])]);
                addRow(['Payment #', 'Principal', 'Interest', 'Ending Balance'].map(h => S.cell(h, ['bold', 'right'])));
                results.amortizationSchedule.slice(0, maxMonthsToShow).forEach(p => {
                    addRow([ S.cell(p.month, ['number']), S.cell(p.principal, ['currencyCents']), S.cell(p.interest, ['currencyCents']), S.cell(p.endingBalance, ['currencyCents']) ]);
                });

                const columnWidths = [ {wch:28}, {wch:15}, {wch:28}, {wch:15}, {wch:5}, {wch:25}, {wch:15}, {wch:15}, {wch:15} ];
                return { sheetData: data, merges, columnWidths };
            }
        };

        App.init();
        document.getElementById('copyright-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
